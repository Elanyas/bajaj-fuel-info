<!DOCTYPE html>
<html lang="am">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2XX2B3RSGP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-2XX2B3RSGP');
  </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ã®·àò·à®·åÉ ·àç·ãç·ãç·å• - ·â£·åÉ·åÖ ·àò·à®·åÉ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Ethiopic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* General styles from style.css */
        body {
            font-family: 'Noto Sans Ethiopic', sans-serif;
            background-color: #2c2c2c; /* Darker background */
            color: #e0e0e0; /* Light text */
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #1e1e1e; /* Dark background for content */
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        h2 {
            color: #00bcd4; /* Accent color */
            border-bottom: 2px solid #00bcd4;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .search-filter-section {
            margin-bottom: 20px;
            text-align: center;
        }

        #searchInput {
            width: 80%;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1em;
        }

        /* Styles specific to this page */
        .posts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .community-post-card {
            background-color: #2a2a2a; /* Darker card background */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Pushes footer/vote-controls to bottom */
        }

        .community-post-card h3 {
            color: #00bcd4;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .community-post-card p {
            margin-bottom: 8px;
        }

        .community-post-card .post-content {
            flex-grow: 1; /* Allows content to take up available space */
            margin-bottom: 15px; /* Space before vote controls */
        }

        .vote-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #3a3a3a;
        }

        .vote-controls button {
            background: none;
            border: 1px solid #00bcd4;
            color: #00bcd4;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .vote-controls button:hover {
            background-color: #00bcd4;
            color: white;
        }

        .vote-controls button.liked {
            background-color: #00bcd4;
            color: white;
        }

        .vote-controls button.disliked {
            background-color: #f44336;
            color: white;
            border-color: #f44336;
        }

        .vote-controls span {
            font-size: 1.1em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .loading-message {
            text-align: center;
            font-style: italic;
            color: #ccc;
        }
    </style>
</head>
<body>
    <header class="main-header">
      <div class="menu-container"> <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button> <nav id="dropdown-menu" class="dropdown-content"> <a href="data.html">·ãã·äì·ãç ·åà·åΩ</a> <a href="stations_fuel_data.html">·ã®·â∞·à®·åã·åà·å† ·ã®·àõ·ã∞·ã´·ãé·âΩ ·àò·à®·åÉ</a> 
      <a href="news.html">·ãú·äì·ãé·âΩ</a> <a href="sales.html">·àò·à∏·å´</a> <a href="maintenance.html">·ä•·äï·ä≠·â•·ä´·â§</a> <a href="data_entry.html">·àò·à®·åÉ ·àõ·àµ·åà·â¢·ã´</a> <a href="community_data.html">·àç·ãç·ãç·å•</a> <a href="fuel_stations.html">·ã®·â∞·å†·âÉ·àö·ãé·âΩ ·ã®·àõ·ã∞·ã´ ·àò·à®·åÉ</a> </nav> </div>
       <div class="ad-marquee-container">
        <p class="ad-marquee-text">
            ‚ú®  ·ã®·äê·çÉ ·àù·ãù·åà·â£ ·åÄ·àù·à®·äì·àç! &nbsp; &nbsp; &nbsp; &nbsp;
            üí° ·ã≠·àÖ·äï·äï ·ä•·ãµ·àç ·àà·àå·àé·âΩ ·àπ·çå·à≠ ·åì·ã∞·äû·âΩ·ãé ·ä†·à≥·ãé·âÄ·ãã·àç? &nbsp; &nbsp; &nbsp; &nbsp;
            üí∞ ·ã≠·àÖ·äï·äï ·à∞·çä ·ã®·àò·åà·äì·äõ ·àò·ãµ·à®·ä≠ ·ä•·äì ·ã®·àò·à®·åÉ ·àù·äï·å≠ ·àà·àå·àé·âΩ ·åì·ã∞·äû·âæ·àù ·ã´·àµ·â∞·ãã·ãç·âÅ! &nbsp; &nbsp; &nbsp; &nbsp;
            üõ†Ô∏è ·ã®·ä†·åà·àç·åç·àé·â≥·âΩ·äï ·â∞·å†·âÉ·àö ·àµ·àà·àÜ·äë ·ä•·äì·àò·à∞·åç·äì·àà·äï! &nbsp; &nbsp; &nbsp; &nbsp;
        </p>
      </div>
      
        <h1><span class="accent-text">·ã®·àò·à®·åÉ </span>·àç·ãç·ãç·å•</h1>
        <p>·â∞·å†·âÉ·àö·ãé·âΩ ·àò·à®·åÉ ·ã®·àö·àà·ãã·ãà·å°·â†·âµ ·àò·ãµ·à®·ä≠·ç¢</p>
        
    </header>

    <main class="container">
        <section class="search-filter-section">
            <input type="text" id="searchInput" placeholder="·çñ·àµ·â∂·âΩ·äï ·çà·àç·åç...">
        </section>

        <section class="community-posts-display">
            <h2>·ã®·âÖ·à≠·â• ·åä·ãú ·àõ·àÖ·â†·à®·à∞·â• ·àç·å•·çé·âΩ</h2>
            <div id="postsContainer" class="posts-container">
                <p class="loading-message">·àç·å•·çé·âΩ ·ä•·ã®·â∞·å´·äë ·äê·ãç...</p>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <p>&copy; 2024 ·â£·åÉ·åÖ ·àò·à®·åÉ. ·àÅ·àâ·àù ·àò·â•·â∂·âΩ ·ã®·â∞·å†·â†·âÅ ·äì·â∏·ãç·ç¢</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit, doc, updateDoc, deleteDoc, addDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA-ywRuhanxoEJgR83jwp_-nOkPY4jLOH4",
            authDomain: "elanyas-info.firebaseapp.com",
            projectId: "elanyas-info",
            storageBucket: "elanyas-info.firebasestorage.app",
            messagingSenderId: "769306910360",
            appId: "1:769306910360:web:70988eed5b1da5ffa0faed",
            measurementId: "G-2XX2B3RSGP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function() {
            const logoutButton = document.getElementById('logoutButton');
            const postsContainer = document.getElementById('postsContainer');
            const searchInput = document.getElementById('searchInput');

            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const loggedInUserName = localStorage.getItem('loggedInUserName');
            const loggedInUserPhone = localStorage.getItem('loggedInUserPhone');
            const loggedInUserPassword = localStorage.getItem('loggedInUserPassword');
            const loggedInUserLastPaymentDate = localStorage.getItem('loggedInUserLastPaymentDate'); // ISO string format

            // Check if user is logged in and has all required info
            if (!isLoggedIn || !loggedInUserName || !loggedInUserPhone || !loggedInUserPassword) {
                alert("·ã≠·àÖ·äï·äï ·åà·åΩ ·àà·àò·å†·âÄ·àù ·àò·åç·â£·âµ ·ä†·àà·â•·ãé·âµ·ç¢");
                localStorage.clear(); 
                window.location.href = 'login.html'; 
                return;
            }

            // Check if subscription is active (within 30 days from last payment)
            const today = new Date();
            const lastPaymentDate = new Date(loggedInUserLastPaymentDate);
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            if (lastPaymentDate < thirtyDaysAgo) {
                alert("·ã®·ã∞·äï·â†·äù·äê·âµ ·àù·ãù·åà·â£·ãé ·åä·ãú·ãç ·ä†·àç·çé·â†·â≥·àç·ç¢ ·ä•·â£·ä≠·ãé ·ã´·ãµ·à±·ç¢");
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('loggedInUserName');
                localStorage.removeItem('loggedInUserPhone');
                localStorage.removeItem('loggedInUserPassword');
                localStorage.removeItem('loggedInUserLastPaymentDate');
                window.location.href = 'login.html'; 
                return;
            }


            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('loggedInUserName');
                    localStorage.removeItem('loggedInUserPhone');
                    localStorage.removeItem('loggedInUserPassword');
                    localStorage.removeItem('loggedInUserLastPaymentDate');
                    alert("·â†·â∞·à≥·ä´ ·àÅ·äî·â≥ ·ãà·å•·â∞·ãã·àç!");
                    window.location.href = "login.html"; 
                });
            }

            let allCommunityPosts = []; // To store all fetched posts for search functionality

            // Function to fetch and display posts
            async function fetchAllCommunityPosts() {
                try {
                    const q = query(collection(db, "communityPosts"), orderBy("timestamp", "desc"), limit(20));
                    const querySnapshot = await getDocs(q);
                    allCommunityPosts = []; // Clear previous posts for fresh load or search
                    postsContainer.innerHTML = ''; // Clear display area

                    if (querySnapshot.empty) {
                        postsContainer.innerHTML = '<p class="loading-message">·àù·äï·àù ·àç·å•·çé·âΩ ·ä†·àç·â∞·åà·äô·àù·ç¢</p>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const post = doc.data();
                        const postId = doc.id;
                        // Ensure likes and dislikes are arrays
                        const likes = post.likes || [];
                        const dislikes = post.dislikes || [];
                        
                        // ·ã®·àà·å£·çä·ãç·äï ·àµ·àù (authorName) ·â•·âª ·àà·àõ·à≥·ã®·âµ
                        const displayAuthorName = post.authorName || '·ã´·àç·â≥·ãà·âÄ'; // authorName ·â∞·å†·âÄ·àù
                        // ·ã®·àµ·àç·ä≠ ·âÅ·å•·à©·äï ·ä®·àõ·à≥·ã´ ·àã·ã≠ ·ä†·àµ·ãà·åç·ãµ
                        // const displayAuthorPhone = post.author ? ` (${post.author})` : ''; 

                        const postCard = document.createElement('div');
                        postCard.className = 'community-post-card';
                        postCard.innerHTML = `
                            <h3>${post.title}</h3>
                            <p><strong>·ã®·àà·å†·çà·ãç:</strong> ${displayAuthorName}</p>
                            <p class="post-content">${post.content}</p>
                            <p><strong>·ã®·â∞·àà·å†·çà·â†·âµ ·âÄ·äï:</strong> ${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString('am-ET') : '·ã´·àç·â≥·ãà·âÄ'}</p>
                            
                            <div class="vote-controls">
                                <button class="like-button ${likes.includes(loggedInUserPhone) ? 'liked' : ''}" data-id="${postId}">üëç <span class="like-count">${likes.length}</span></button>
                                <button class="dislike-button ${dislikes.includes(loggedInUserPhone) ? 'disliked' : ''}" data-id="${postId}">üëé <span class="dislike-count">${dislikes.length}</span></button>
                            </div>
                        `;
                        postsContainer.appendChild(postCard);
                        allCommunityPosts.push({ id: postId, ...post });
                    });

                    // Attach event listeners after all cards are added
                    document.querySelectorAll('.like-button').forEach(button => {
                        button.addEventListener('click', (e) => handleVote(e, 'like'));
                    });
                    document.querySelectorAll('.dislike-button').forEach(button => {
                        button.addEventListener('click', (e) => handleVote(e, 'dislike'));
                    });

                } catch (error) {
                    console.error("Error fetching community posts:", error);
                    postsContainer.innerHTML = '<p class="loading-message" style="color: #f44336;">·àç·å•·çé·âΩ·äï ·â†·àò·å´·äï ·àã·ã≠ ·àµ·àÖ·â∞·âµ ·â∞·çà·å•·àØ·àç: ' + error.message + '</p>';
                }
            }

            // Function to handle like/dislike votes
            async function handleVote(event, type) {
                const button = event.currentTarget;
                const postId = button.dataset.id;
                const postRef = doc(db, "communityPosts", postId);

                if (!loggedInUserPhone) {
                    alert("·àà·ãµ·àù·çÖ ·àò·àµ·å†·âµ ·àò·åç·â£·âµ ·ä†·àà·â•·ãé·âµ·ç¢");
                    return;
                }

                try {
                    const docSnap = await getDoc(postRef); 
                    if (!docSnap.exists()) {
                        console.error("No such document!");
                        alert("·àç·å•·çâ ·ä†·àç·â∞·åà·äò·àù·ç¢");
                        return;
                    }

                    const currentLikes = docSnap.data().likes || [];
                    const currentDislikes = docSnap.data().dislikes || [];
                    const postAuthorPhone = docSnap.data().author; // author·äï ·ä•·äï·ã∞ ·àµ·àç·ä≠ ·âÅ·å•·à≠ ·â∞·å†·âÄ·àù

                    let newLikes = [...currentLikes];
                    let newDislikes = [...currentDislikes];

                    const isAlreadyLiked = newLikes.includes(loggedInUserPhone);
                    const isAlreadyDisliked = newDislikes.includes(loggedInUserPhone);

                    if (type === 'like') {
                        if (isAlreadyLiked) {
                            newLikes = newLikes.filter(phone => phone !== loggedInUserPhone);
                            button.classList.remove('liked');
                        } else {
                            newLikes.push(loggedInUserPhone);
                            button.classList.add('liked');
                            if (isAlreadyDisliked) {
                                newDislikes = newDislikes.filter(phone => phone !== loggedInUserPhone);
                                document.querySelector(`.dislike-button[data-id="${postId}"]`).classList.remove('disliked');
                            }
                        }
                    } else if (type === 'dislike') {
                        if (isAlreadyDisliked) {
                            newDislikes = newDislikes.filter(phone => phone !== loggedInUserPhone);
                            button.classList.remove('disliked');
                        } else {
                            newDislikes.push(loggedInUserPhone);
                            button.classList.add('disliked');
                            if (isAlreadyLiked) {
                                newLikes = newLikes.filter(phone => phone !== loggedInUserPhone);
                                document.querySelector(`.like-button[data-id="${postId}"]`).classList.remove('liked');
                            }
                        }
                    }

                    await updateDoc(postRef, {
                        likes: newLikes,
                        dislikes: newDislikes
                    });

                    // Update counts on the page directly
                    document.querySelector(`.like-button[data-id="${postId}"] .like-count`).textContent = newLikes.length;
                    document.querySelector(`.dislike-button[data-id="${postId}"] .dislike-count`).textContent = newDislikes.length;

                    // Automated Deletion and Ban Logic
                    if (type === 'dislike' && newDislikes.length >= 5) {
                        if (!(newLikes.length >= 15 && newDislikes.length >= 10)) {
                            await deleteDoc(postRef); 
                            console.log(`Post ${postId} deleted due to excessive dislikes.`);
                            alert("·àç·å•·çâ ·â†·â∞·ã∞·åã·åã·àö ·ã≤·àµ·àã·ã≠·ä≠ ·â†·àò·ã∞·à®·åâ ·â∞·à∞·à≠·ãü·àç·ç¢");

                            if (postAuthorPhone) {
                                await addDoc(collection(db, "falspost"), {
                                    phoneNumber: postAuthorPhone,
                                    reason: "Community Post Deleted due to excessive dislikes",
                                    timestamp: new Date()
                                });
                                console.log(`Author ${postAuthorPhone} added to falspost.`);
                                await checkAndBanUser(postAuthorPhone);
                            }
                            fetchAllCommunityPosts(); // Refresh list after deletion
                        }
                    }

                } catch (error) {
                    console.error("Vote operation failed:", error);
                    alert("·ãµ·àù·çÖ ·àà·àò·àµ·å†·âµ ·ä†·àç·â∞·âª·àà·àù·ç¢ ·ä•·â£·ä≠·ãé ·ä•·äï·ã∞·åà·äì ·ã≠·àû·ä≠·à©·ç¢ " + error.message);
                }
            }

            async function checkAndBanUser(phoneNumber) {
                try {
                    const falspostQuery = query(collection(db, "falspost"), where("phoneNumber", "==", phoneNumber));
                    const falspostSnapshot = await getDocs(falspostQuery);

                    if (falspostSnapshot.size >= 3) {
                        const banusersRef = collection(db, "banusers");
                        const banQuery = query(banusersRef, where("phoneNumber", "==", phoneNumber));
                        const banSnapshot = await getDocs(banQuery);

                        if (banSnapshot.empty) {
                            await addDoc(banusersRef, {
                                phoneNumber: phoneNumber,
                                bannedAt: new Date()
                            });
                            console.log(`User ${phoneNumber} has been banned.`);
                            alert(`·â∞·å†·âÉ·àö ${phoneNumber} ·â†·â∞·ã∞·åã·åã·àö ·ã®·â∞·à≥·à≥·â∞ ·àò·à®·åÉ ·â†·àò·àà·å†·çâ ·â∞·åà·ãµ·âß·àç·ç¢`);
                        } else {
                            console.log(`User ${phoneNumber} is already banned.`);
                        }
                    }
                } catch (error) {
                    console.error("Error checking or banning user:", error);
                }
            }

            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredPosts = allCommunityPosts.filter(post => {
                    // search by authorName, title, or content
                    const authorName = (post.authorName || '').toLowerCase(); 
                    const title = (post.title || '').toLowerCase();
                    const content = (post.content || '').toLowerCase();
                    
                    return authorName.includes(searchTerm) || 
                           title.includes(searchTerm) || 
                           content.includes(searchTerm);
                });
                displayPosts(filteredPosts);
            });

            // Display filtered posts (re-use logic from initial fetch, but only render)
            function displayPosts(postsToDisplay) {
                postsContainer.innerHTML = ''; // Clear existing posts
                if (postsToDisplay.length === 0) {
                    postsContainer.innerHTML = '<p class="loading-message">·àù·äï·àù ·ã®·àö·ãõ·àò·ã± ·àç·å•·çé·âΩ ·ä†·àç·â∞·åà·äô·àù·ç¢</p>';
                    return;
                }
                postsToDisplay.forEach((post) => {
                    const postId = post.id;
                    const likes = post.likes || [];
                    const dislikes = post.dislikes || [];

                    const displayAuthorName = post.authorName || '·ã´·àç·â≥·ãà·âÄ';
                    // ·ã®·àµ·àç·ä≠ ·âÅ·å•·à©·äï ·ä®·àõ·à≥·ã´ ·àã·ã≠ ·ä†·àµ·ãà·åç·ãµ
                    // const displayAuthorPhone = post.author ? ` (${post.author})` : '';

                    const postCard = document.createElement('div');
                    postCard.className = 'community-post-card';
                    postCard.innerHTML = `
                        <h3>${post.title}</h3>
                        <p><strong>·ã®·àà·å†·çà·ãç:</strong> ${displayAuthorName}</p>
                        <p class="post-content">${post.content}</p>
                        <p><strong>·ã®·â∞·àà·å†·çà·â†·âµ ·âÄ·äï:</strong> ${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString('am-ET') : '·ã´·àç·â≥·ãà·âÄ'}</p>
                        
                        <div class="vote-controls">
                            <button class="like-button ${likes.includes(loggedInUserPhone) ? 'liked' : ''}" data-id="${postId}">üëç <span class="like-count">${likes.length}</span></button>
                            <button class="dislike-button ${dislikes.includes(loggedInUserPhone) ? 'disliked' : ''}" data-id="${postId}">üëé <span class="dislike-count">${dislikes.length}</span></button>
                        </div>
                    `;
                    postsContainer.appendChild(postCard);
                });

                // Re-attach event listeners to newly rendered cards
                document.querySelectorAll('.like-button').forEach(button => {
                    button.addEventListener('click', (e) => handleVote(e, 'like'));
                });
                document.querySelectorAll('.dislike-button').forEach(button => {
                    button.addEventListener('click', (e) => handleVote(e, 'dislike'));
                });
            }

            // Fetch posts when the page loads
            fetchAllCommunityPosts();

            console.log("Community Data display page loaded with voting and ban system.");
        });
    </script>
  <script src="main.js"></script>  
</body>
</html>