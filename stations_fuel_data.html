<!DOCTYPE html>
<html lang="am">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GW2Y1BE243"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GW2Y1BE243');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>የድራይቨር ነዳጅ መረጃ - የማደያዎች መረጃ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Ethiopic:wght@400;700&display=swap" rel="stylesheet">
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const loggedInUserName = localStorage.getItem('loggedInUserName');
        const loggedInUserPhone = localStorage.getItem('loggedInUserPhone');
        const loggedInUserPassword = localStorage.getItem('loggedInUserPassword');
        const loggedInUserLastPaymentDate = localStorage.getItem('loggedInUserLastPaymentDate');

        if (!isLoggedIn || !loggedInUserName || !loggedInUserPhone || !loggedInUserPassword || !loggedInUserLastPaymentDate) {
            alert("ለመግባት ፍቃድ የለዎትም። እባክዎ እንደገና ይግቡ።");
            localStorage.clear();
            window.location.href = 'login.html';
            return;
        }
        
        // ------------------------------------------------------------------
        // **ለውጥ 2**: የአፑን ስልክ ቁጥር ማረጋገጫ ስርአት መጨመር (ከQuery Parameter)
        // ------------------------------------------------------------------
        
        // 1. የ URL Query Parameter ማንበብ (ከአፑ የመጣውን ቁጥር)
        const urlParams = new URLSearchParams(window.location.search);
        const appPhoneNumber = urlParams.get('phone'); // ?phone=09XXXXXXXX

        if (appPhoneNumber) {
            // 2. ቁጥር ከአፑ ከተላከ (Case B እና C): ማመሳሰል
            
            // የሎካል ስቶሬጁን ቁጥር አጽድተን ማመሳሰል (ምናልባት 09XXXXXXXX ብቻ እንዲሆን)
            const cleanedLocalPhone = loggedInUserPhone ? loggedInUserPhone.replace(/\s/g, '') : null;
            const cleanedAppPhone = appPhoneNumber.replace(/\s/g, '');

            if (cleanedLocalPhone !== cleanedAppPhone) {
                // Case C: ቁጥሮቹ ካልተመሳሰሉ
                alert("እባክዎ ትክክለኛ ቁጥሮን ይጠቀሙ! ይህ መለያ ከዚህኛው የአፕሊኬሽን ስልክ ቁጥር ጋር አልተመሳሰለም።");
                localStorage.clear();
                window.location.href = 'login.html';
                return;
            }
            // Case B: ቁጥሮቹ ከተመሳሰሉ - ማስፈጸም ይቀጥላል (ወደ Subscription Check ይሄዳል)
        }
        // Case A: ቁጥር ካልተላከ (በብራውዘር ሲገባ) - ማስፈጸም ይቀጥላል (ወደ Subscription Check ይሄዳል)
        
        // ------------------------------------------------------------------
        // **ለውጥ 2 ማብቂያ**
        // ------------------------------------------------------------------



        try {
            const SUBSCRIPTION_DURATION_DAYS = 30;
            const lastPaymentDate = new Date(loggedInUserLastPaymentDate);
            const today = new Date();
            const expirationDate = new Date(lastPaymentDate);
            expirationDate.setDate(expirationDate.getDate() + SUBSCRIPTION_DURATION_DAYS);

            if (today > expirationDate) {
                alert("የደንበኝነት ምዝገባ ጊዜዎ አልቋል። እባክዎ ያድሱ።");
                localStorage.clear();
                window.location.href = 'login.html';
                return;
            }
        } catch (error) {
            console.error("የክፍያ ቀን ሲረጋገጥ ስህተት ተፈጠረ:", error);
            alert("የመግባት ፍቃድዎ ሊረጋገጥ አልቻለም። እባክዎ እንደገና ይግቡ።");
            localStorage.clear();
            window.location.href = 'login.html';
            return;
        }

        const postAuthorInput = document.getElementById('postAuthor');
        if (postAuthorInput) {
            postAuthorInput.value = loggedInUserName;
        }
    });
</script>
    <style>
        /* ተጨማሪ የ CSS ስታይሎች ለተሻለ አቀማመጥ - ከዋናው data.html ኮፒ የተደረጉ */
        .fuel-type-details {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .fuel-type-details p {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .fuel-type-details h3 {
            color: #00bcd4;
            margin-bottom: 10px;
        }
        .fuel-status strong {
            font-size: 1.1em;
            color: #00bcd4;
        }
        .fuel-status.unavailable strong {
            color: #f44336;
        }
        .fuel-station-card {
            background-color: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 25px;
            padding: 25px;
            color: #e0e0e0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .fuel-station-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .fuel-station-card h2 {
            color: #ffffff;
            font-size: 1.8em;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #00bcd4;
            padding-bottom: 10px;
        }

        .station-name-english {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-top: -5px;
            margin-bottom: 15px;
        }

        .last-updated {
            font-size: 0.95em;
            color: #888;
            text-align: right;
            margin-top: 20px;
        }

        .filter-buttons {
            text-align: center;
            margin-bottom: 30px;
        }

        .filter-buttons button {
            background-color: #00bcd4;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 8px;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .filter-buttons button:hover {
            background-color: #0097a7;
        }

        .message {
            text-align: center;
            margin: 20px auto;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            max-width: 600px;
            background-color: #ffe0b2;
            color: #e65100;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #00bcd4;
        }

        .additional-notes {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #444;
            font-style: italic;
            color: #a0a0a0;
            font-size: 0.95em;
        }

        .posted-by {
            font-size: 0.95em;
            color: #888;
            margin-top: 10px;
            text-align: left;
        }
        
        /* የተጨመረው ኮድ */
        /* ለሰርች ቦታው ስታይል በሞባይል */
        .search-filter-section {
            margin-bottom: 20px;
            padding: 0 15px; /* ከስክሪኑ ጠርዝ ርቀት ለመፍጠር */
        }
        #searchInput {
            width: 100%; /* ሙሉ ስክሪኑን እንዲሸፍን */
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2a2a2a;
            color: #e0e0e0;
            font-size: 1em;
            box-sizing: border-box; /* padding እና border በ width ውስጥ እንዲካተቱ */
        }

        /* የሰርች ቦታው በላፕቶፕ እና በትላልቅ ስክሪኖች ላይ እንዲታይ ለማድረግ የተጨመረው Media Query */
        @media (min-width: 768px) {
            .search-filter-section {
                text-align: center;
                margin-bottom: 30px;
            }
            #searchInput {
                max-width: 500px; /* በትልቅ ስክሪን ላይ ጠባብ እንዲሆን */
                display: inline-block; /* ለመሃል ላይ ማምጣት */
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
      <div class="menu-container"> <button class="menu-btn" onclick="toggleMenu()">☰</button> <nav id="dropdown-menu" class="dropdown-content"> <a href="data.html">ዋናው ገጽ</a>  <a href="stations_fuel_data.html">የተረጋገጠ የማደያዎች መረጃ</a> 
      <a href="news.html">ዜናዎች</a> <a href="sales.html">መሸጫ</a> <a href="maintenance.html">እንክብካቤ</a> <a href="data_entry.html">መረጃ ማስገቢያ</a> <a href="community_data.html">ልውውጥ</a> <a href="fuel_stations.html">የተጠቃሚዎች የማደያ መረጃ</a> </nav> </div>
      <div class="ad-marquee-container">
        <p class="ad-marquee-text">
            ✨  የነፃ ምዝገባ ጀምረናል! &nbsp; &nbsp; &nbsp; &nbsp;
            💡 ይህንን እድል ለሌሎች ሹፌር ጓደኞችዎ አሳዎቀዋል? &nbsp; &nbsp; &nbsp; &nbsp;
            💰 ይህንን ሰፊ የመገናኛ መድረክ እና የመረጃ ምንጭ ለሌሎች ጓደኞቾም ያስተዋውቁ! &nbsp; &nbsp; &nbsp; &nbsp;
            🛠️ የአገልግሎታችን ተጠቃሚ ስለሆኑ እናመሰግናለን! &nbsp; &nbsp; &nbsp; &nbsp;
        </p>
      </div>
        <h1><span class="accent-text">የማደያዎች የነዳጅ</span> መረጃ</h1>
        <p>ወቅታዊ የነዳጅ ዋጋና ወረፋ መረጃዎች</p>
        
    </header>

    <main class="container">
      
      <section class="search-filter-section">
            <input type="text" id="searchInput" placeholder="የማደያ ስም፣ 'አለ' ወይም 'የለም' ፈልግ...">
        </section>

        <div id="loadingMessage" class="loading-message">መረጃዎች እየተጫኑ ነው...</div>
        <div id="errorMessageDisplay" class="message error" style="display: none;"></div>
        <div id="fuelStationList">
            </div>
    </main>

    <footer class="main-footer">
        <p>&copy; 2025 የድራይቨር ነዳጅ መረጃ. ሁሉም መብቶች የተጠበቁ ናቸው።</p>
        <p>ለወቅታዊ መረጃ ድረ-ገጻችንን ይጎብኙ።</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-ywRuhanxoEJgR83jwp_-nOkPY4jLOH4",
            authDomain: "elanyas-info.firebaseapp.com",
            projectId: "elanyas-info",
            storageBucket: "elanyas-info.firebasestorage.app",
            messagingSenderId: "769306910360",
            appId: "1:769306910360:web:70988eed5b1da8ffa0faed",
            measurementId: "G-2XX2B3RSGP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const fuelStationList = document.getElementById('fuelStationList');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessageDisplay = document.getElementById('errorMessageDisplay');
        const searchInput = document.getElementById('searchInput');

        let allFuelStations = [];

        document.addEventListener('DOMContentLoaded', fetchFuelStationData);
        
// ******************************************************************
// 🚨 አዲስ የተጨመረ ኮድ፡ Time Ago ተግባር 🚨
// ******************************************************************

// ይህ ተግባር በDate object ከተሰጠው ጊዜ ጀምሮ ያለፈውን ጊዜ ያሰላል
function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    // በሰከንድ ውስጥ ያሉ የጊዜ ክፍተቶች
    let interval = seconds / 31536000; // አመት (Year)
    if (interval > 1) {
        const value = Math.floor(interval);
        return value + " " + (value === 1 ? "ዓመት" : "ዓመታት") + " በፊት";
    }
    interval = seconds / 2592000; // ወር (Month)
    if (interval > 1) {
        const value = Math.floor(interval);
        return value + " " + (value === 1 ? "ወር" : "ወራት") + " በፊት";
    }
    interval = seconds / 86400; // ቀን (Day)
    if (interval > 1) {
        const value = Math.floor(interval);
        return value + " " + (value === 1 ? "ቀን" : "ቀናት") + " በፊት";
    }
    interval = seconds / 3600; // ሰዓት (Hour)
    if (interval > 1) {
        const value = Math.floor(interval);
        return value + " " + (value === 1 ? "ሰዓት" : "ሰዓታት") + " በፊት";
    }
    interval = seconds / 60; // ደቂቃ (Minute)
    if (interval > 1) {
        const value = Math.floor(interval);
        return value + " " + (value === 1 ? "ደቂቃ" : "ደቂቃዎች") + " በፊት";
    }
    
    // ከ 60 ሰከንድ በታች ከሆነ
    return "ከጥቂት ሰከንዶች በፊት";
}

// ******************************************************************
// 🚨 አዲስ የተጨመረ ኮድ ማብቂያ 🚨
// ******************************************************************

        async function fetchFuelStationData() {
            loadingMessage.style.display = 'block';
            errorMessageDisplay.style.display = 'none';
            fuelStationList.innerHTML = '';

            try {
                const q = query(collection(db, "fueldata"), orderBy("lastUpdated", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    fuelStationList.innerHTML = '<p style="text-align: center; color: #a0a0a0;">ምንም የነዳጅ ማደያ መረጃ የለም። በቅርቡ ማደያዎች መረጃዎቻቸውን በዚ ፔጅ ለይ ማሳወቅ ይጀምራሉ።</p>';
                    loadingMessage.style.display = 'none';
                    return;
                }
                
                allFuelStations = [];
                querySnapshot.forEach((doc) => {
                    allFuelStations.push(doc.data());
                });

                displayFuelStations(allFuelStations);

            } catch (error) {
                console.error("መረጃዎችን ከFirebase ሲያመጡ ስህተት ተፈጠረ:", error);
                loadingMessage.style.display = 'none';
                errorMessageDisplay.textContent = "መረጃዎችን ማምጣት አልተቻለም። እባክዎ እንደገና ይሞክሩ።";
                errorMessageDisplay.style.display = 'block';
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        function displayFuelStations(stationsToDisplay) {
            fuelStationList.innerHTML = '';
            if (stationsToDisplay.length === 0) {
                fuelStationList.innerHTML = '<p style="text-align: center; color: #a0a0a0;">የተፈለገው መረጃ የለም።</p>';
                return;
            }

            stationsToDisplay.forEach((data) => {
// ------------------------------------
// 🚨 የመተኪያ ኮድ 🚨
// ------------------------------------
                let lastUpdated = 'አልታወቀም';
                if (data.lastUpdated && data.lastUpdated.toDate) {
                    // አዲስ የፈጠርነውን timeAgo ተግባር በመጠቀም
                    const dateObject = data.lastUpdated.toDate();
                    lastUpdated = timeAgo(dateObject); 
                }
// ------------------------------------

                const cardHtml = `
                    <div class="fuel-station-card">
                        <h2 class="station-name">${data.stationName || 'ያልታወቀ ማደያ'}</h2>
                        ${data.stationNameEnglish ? `<p class="station-name-english">${data.stationNameEnglish}</p>` : ''}
                        <div class="fuel-type-details petrol">
                            <h3>ቤንዚን:</h3>
                            <p class="fuel-status">ሁኔታ: <strong>${data.petrolStatus || 'አልታወቀም'}</strong></p>
                            <p>ዋጋ: <strong>${data.petrolPrice ? `${data.petrolPrice.toFixed(2)} ብር/ሊትር` : 'አልታወቀም'}</strong></p>
                            <p class="fuel-status">የወረፋ ሁኔታ: <strong>${data.petrolQueue || 'አልታወቀም'}</strong></p>
                        </div>
                        <div class="fuel-type-details diesel">
                            <h3>ናፍጣ:</h3>
                            <p class="fuel-status">ሁኔታ: <strong>${data.dieselStatus || 'አልታወቀም'}</strong></p>
                            <p>ዋጋ: <strong>${data.dieselPrice ? `${data.dieselPrice.toFixed(2)} ብር/ሊትር` : 'አልታወቀም'}</strong></p>
                            <p class="fuel-status">የወረፋ ሁኔታ: <strong>${data.dieselQueue || 'አልታወቀም'}</strong></p>
                        </div>
                        ${data.additionalNotes ? `<p class="additional-notes">ማብራሪያ: ${data.additionalNotes}</p>` : ''}
                        <p class="posted-by">የተለጠፈው በ: <strong>${data.postedBy || 'ያልታወቀ'}</strong></p>
                        <p class="last-updated">የመጨረሻ ዝመና: ${lastUpdated}</p>
                    </div>
                `;
                fuelStationList.innerHTML += cardHtml;
            });
        }


        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('stationPassword');
                localStorage.removeItem('stationNameAmh');
                localStorage.removeItem('stationNameEng');
                localStorage.removeItem('stationDocId');
                alert("በተሳካ ሁኔታ ወጥተዋል!");
                window.location.href = "login.html";
            });
        }

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredStations = allFuelStations.filter(station => {
                const stationName = (station.stationName || '').toLowerCase();
                const petrolStatus = (station.petrolStatus || '').toLowerCase();
                const dieselStatus = (station.dieselStatus || '').toLowerCase();

                return stationName.includes(searchTerm) ||
                       petrolStatus.includes(searchTerm) ||
                       dieselStatus.includes(searchTerm);
            });
            displayFuelStations(filteredStations);
        });

    </script>
<script src="main.js"></script>
</body>
</html>