<!DOCTYPE html>
<html lang="am">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2XX2B3RSGP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-2XX2B3RSGP');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áˆá‹á‹áŒ¥ - á‹¨áˆ˜áˆ¨áŒƒ áˆ›á‹•áŠ¨áˆ</title>
    
    <link rel="stylesheet" href="style.css"> 
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Ethiopic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* 1. General & Container Overrides to match original structure */
        .container {
            max-width: 1200px;
            /* áˆ´áŠ•á‰°áˆ­ áŠ¥áŠ•á‹²á‹­á‹ */
            margin: 20px auto; 
            padding: 20px;
            background-color: #1e1e1e; /* Dark background for content */
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            min-height: 80vh;
            /* áˆˆáˆá‰£á‹­áˆ áŠ¥á‹­á‰³ á‰ áŒáŠ• á‰ áŠ©áˆ á‰µáŠ•áˆ½ áŠ­áá‰°á‰µ áŠ¥áŠ•á‹²áŠ–áˆ¨á‹ */
            width: 95%; 
        }

        /* 2. Navigation Buttons Style (áŠ á‹áˆ«áˆ®á‰½áŠ• á‰ áŒ£áˆ á‰µáŠ“áŠ•áˆ½ áŠ¥áŠ“ áŒáŠ• áˆˆáŒáŠ•) */
        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px; /* áŠ­áá‰°á‰±áŠ• áˆ˜á‰€áŠáˆµ */
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap; 
        }

        .navigation-buttons button {
            background-color: #00bcd455; 
            color: #e0e0e0;
            padding: 8px 15px; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em; 
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            white-space: nowrap; 
        }

        /* 3. Active Button Style (áˆ²áŠáŠ« á‹ˆá‹° áˆ‹á‹­ á‰¥á‹µáŒ á‹«áˆˆ áˆ˜áˆáŠ­ áŠ¥áŠ“ á‹¨áˆ²á‹«áŠ• áŒ¥áˆ‹) */
        .navigation-buttons button.active {
            background-color: #00bcd4; 
            box-shadow: 0 8px 15px #00bcd466; 
            transform: translateY(-3px); 
            color: #1e1e1e;
            border: 2px solid #e0e0e0;
        }
        
        /* 4. Content Display Styles (Grid for data cards) */
        .data-display-section {
            padding-top: 20px;
            /* á‹¨áŠ«áˆ­á‹µ áˆ˜á‹«á‹£á‹áŠ• (dataContainer) áˆ´áŠ•á‰°áˆ­ áˆˆáˆ›á‹µáˆ¨áŒ */
            display: flex; 
            flex-direction: column;
            align-items: center; /* á‹¨áˆáŒ†á‰½áŠ• (áŠ«áˆ­á‹µ áŠ®áŠ•á‰´á‹­áŠáˆ®á‰½) áˆ´áŠ•á‰°áˆ­ áˆˆáˆ›á‹µáˆ¨áŒ */
            width: 100%;
        }
        
        /* á‹¨áŠ«áˆ­á‹µ áŠ®áŠ•á‰´á‹­áŠáˆ®á‰½ áŠ á‰€áˆ›áˆ˜áŒ¥ áˆ›áˆµá‰°áŠ«áŠ¨á‹« */
        .posts-container, .stations-list, .tip-offs-list {
            display: grid;
            /* á‹¨áŠ«áˆ­á‹±áŠ• á‹á‰…á‰°áŠ› áˆµá‹á‰µ á‹ˆá‹° 300px áŠ¨á á‰ áˆ›á‹µáˆ¨áŒ áŠ¥áŠ•á‹²áˆ°á‹ áŠ¥áŠ“á‹°áˆ­áŒ‹áˆˆáŠ• */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            padding: 0;
            width: 90%; /* á‹¨á‹‹áŠ“á‹áŠ• áŠ®áŠ•á‰´á‹­áŠáˆ­ áˆµá‹á‰µ áŠ¥áŠ•á‹²á‹­á‹ */
            max-width: 1200px;
            
            /* áˆ´áŠ•á‰°áˆ© á‰  Grid áŠ¥á‰ƒá‹á‰½ áˆ˜áŠ«áŠ¨áˆ á‰ á‰µáŠ­áŠ­áˆ áŠ¥áŠ•á‹²áŠ¨á‹áˆáˆ á‹«áŒá‹›áˆ */
            justify-content: center; 
        }
        
        /* 5. Card Styles */
        .community-post-card, .station-card, .tip-off-card {
            background-color: #2a2a2a;
            padding: 15px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px; 
            /* áŠ«áˆ­á‹± á‰  Grid áˆ…áŒ áŠ¥áŠ•á‹²áˆ˜áˆ« áˆˆáˆ›á‹µáˆ¨áŒ width: 100% á‰°á‹ˆáŒá‹·áˆ */
            align-items: stretch;
        }
        
        .community-post-card h3, .station-card h3, .tip-off-card h3 {
            color: #00bcd4;
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.5em;
            border-bottom: 3px solid #444;
            padding-bottom: 5px;
        }
        
        /* Status Colors */
        .status-indicator.available { background-color: #4CAF50; color: white; }
        .status-indicator.low { background-color: #FFC107; color: #333; }
        .status-indicator.unavailable { background-color: #f44336; color: white; }
        .status-indicator.no-queue { background-color: #2196F3; color: white; }
        .status-indicator.short-queue { background-color: #8BC34A; color: white; }
        .status-indicator.medium-queue { background-color: #FF9800; color: white; }
        .status-indicator.long-queue { background-color: #D32F2F; color: white; }

        /* Vote Controls */
        .vote-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #3a3a3a;
        }
        .vote-controls button {
            background: none;
            border: 1px solid #00bcd4;
            color: #00bcd4;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .vote-controls button.liked { background-color: #00bcd4; color: white; }
        .vote-controls button.disliked { background-color: #f44336; color: white; border-color: #f44336; }
        
        /* Load More Button & Messages */
        #loadMoreButton {
            display: none;
            width: 90%; /* á‰ áˆá‰£á‹­áˆ áŒ¥áˆ© áŠ¥á‹­á‰³ áŠ¥áŠ•á‹²áŠ–áˆ¨á‹ */
            max-width: 400px; /* áŠ¨áá‰°áŠ›á‹áŠ• áˆµá‹á‰µ áˆ˜á‹ˆáˆ°áŠ• */
            padding: 15px;
            background-color: #00bcd4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        .loading-message {
            text-align: center;
            font-style: italic;
            color: #ccc;
            grid-column: 1 / -1; 
            padding: 20px;
        }

        /* 6. Responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                padding: 10px;
            }
            .navigation-buttons {
                justify-content: center; 
                gap: 5px;
            }
            .navigation-buttons button {
                padding: 6px 10px; 
                font-size: 0.8em; 
            }
            /* á‰ á‰µáŠ•áŠ•áˆ½ áˆµáŠ­áˆªáŠ–á‰½ áˆ‹á‹­ áŠ«áˆ­á‹¶á‰½áŠ• á‰ áŠ áŠ•á‹µ áŠ áˆá‹µ áˆ›áˆ³á‹¨á‰µ */
            .posts-container, .stations-list, .tip-offs-list {
                /* á‰ áˆá‰£á‹­áˆ áˆ‹á‹­ áˆ™áˆ‰ áˆµá‹á‰±áŠ• áŠ¥áŠ•á‹²á‹­á‹ */
                grid-template-columns: 1fr;
                gap: 15px; 
                padding: 0 5px; 
            }
        }
    </style>
    
    <script>
        // Global variables for user session (As in original files)
        let isLoggedIn = false;
        let loggedInUserName = '';
        let loggedInUserPhone = '';
        let loggedInUserPassword = '';
        let loggedInUserLastPaymentDate = '';

        // Check login status and subscription before page load (As in original files)
        (function checkAuthAndSubscription() {
            // ... (Your original authentication and subscription check logic goes here) ...
            
            isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            loggedInUserName = localStorage.getItem('loggedInUserName');
            loggedInUserPhone = localStorage.getItem('loggedInUserPhone');
            loggedInUserPassword = localStorage.getItem('loggedInUserPassword');
            loggedInUserLastPaymentDate = localStorage.getItem('loggedInUserLastPaymentDate');

            if (!isLoggedIn || !loggedInUserName || !loggedInUserPhone || !loggedInUserPassword || !loggedInUserLastPaymentDate) {
                // If not logged in, redirect to login.html
                // alert("á‹­áˆ…áŠ•áŠ• áŒˆáŒ½ áˆˆáˆ˜áŒ á‰€áˆ áˆ˜áŒá‰£á‰µ áŠ áˆˆá‰¥á‹á‰µá¢");
                // localStorage.clear(); 
                // window.location.href = 'login.html'; 
                // return;
                console.warn("User session data missing. Running in simulated mode for code demonstration.");
            }
            
            // Check subscription expiration (30 days)
            try {
                const today = new Date();
                const lastPaymentDate = new Date(loggedInUserLastPaymentDate);
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);

                if (lastPaymentDate < thirtyDaysAgo) {
                    // Subscription expired, redirect to login.html
                    // alert("á‹¨á‹°áŠ•á‰ áŠáŠá‰µ áˆá‹áŒˆá‰£á‹ áŒŠá‹œá‹ áŠ áˆáá‰ á‰³áˆá¢ áŠ¥á‰£áŠ­á‹ á‹«á‹µáˆ±á¢");
                    // localStorage.clear();
                    // window.location.href = 'login.html'; 
                    // return;
                     console.warn("Subscription expired. Running in simulated mode for code demonstration.");
                }
            } catch(e) {
                console.error("Subscription check error:", e);
                // alert("á‹¨áˆ˜áŒá‰£á‰µ áá‰ƒá‹µá‹ áˆŠáˆ¨áŒ‹áŒˆáŒ¥ áŠ áˆá‰»áˆˆáˆá¢");
                // localStorage.clear();
                // window.location.href = 'login.html'; 
                // return;
            }
        })();
    </script>

</head>
<body>
    <header class="main-header">
      <div class="menu-container"> <button class="menu-btn" onclick="toggleMenu()">â˜°</button> <nav id="dropdown-menu" class="dropdown-content"> <a href="data.html">á‹‹áŠ“á‹ áŒˆáŒ½</a>  <a href="stations_fuel_data.html">á‹¨á‰°áˆ¨áŒ‹áŒˆáŒ  á‹¨áˆ›á‹°á‹«á‹á‰½ áˆ˜áˆ¨áŒƒ</a> 
      <a href="news.html">á‹œáŠ“á‹á‰½</a> <a href="maintenance.html">áŠ¥áŠ•áŠ­á‰¥áŠ«á‰¤</a> <a href="data_entry.html">áˆ˜áˆ¨áŒƒ áˆ›áˆµáŒˆá‰¢á‹«</a> <a href="combined_community_data.html">áˆá‹á‹áŒ¥</a> </nav> </div>
       <div class="ad-marquee-container">
        <p class="ad-marquee-text">
            âœ¨ á‹¨áŠáƒ áˆá‹áŒˆá‰£ áŒ€áˆáˆ¨áŠ“áˆ! &nbsp; &nbsp; &nbsp; &nbsp;
            ğŸ’¡ á‹­áˆ…áŠ•áŠ• áŠ¥á‹µáˆ áˆˆáˆŒáˆá‰½ áˆ¹áŒáˆ­ áŒ“á‹°áŠá‰½á‹ áŠ áˆ³á‹á‰€á‹‹áˆ? &nbsp; &nbsp; &nbsp; &nbsp;
            ğŸ’° á‹­áˆ…áŠ•áŠ• áˆ°áŠ á‹¨áˆ˜áŒˆáŠ“áŠ› áˆ˜á‹µáˆ¨áŠ­ áŠ¥áŠ“ á‹¨áˆ˜áˆ¨áŒƒ áˆáŠ•áŒ­ áˆˆáˆŒáˆá‰½ áŒ“á‹°áŠá‰¾áˆ á‹«áˆµá‰°á‹‹á‹á‰! &nbsp; &nbsp; &nbsp; &nbsp;
            ğŸ› ï¸ á‹¨áŠ áŒˆáˆáŒáˆá‰³á‰½áŠ• á‰°áŒ á‰ƒáˆš áˆµáˆˆáˆ†áŠ‘ áŠ¥áŠ“áˆ˜áˆ°áŒáŠ“áˆˆáŠ•! &nbsp; &nbsp; &nbsp; &nbsp;
        </p>
      </div>
        <h1><span class="accent-text">áˆá‹á‹áŒ¥</span></h1>
        <p>á‹¨á‰°áŒ á‰ƒáˆšá‹á‰½ á‹¨áˆ›á‹°á‹« áˆ˜áˆ¨áŒƒá‹á‰½á£ á‹¨á‰°á‹˜áŒ‰ á‹¨áˆ˜áŠ•áŒˆá‹µ áŒ¥á‰†áˆ›á‹á‰½ áŠ¥áŠ“ á‹¨áˆ›áˆ…á‰ áˆ¨áˆ°á‰¥ áˆáŒ¥áá‰½</p>
        
        <div class="navigation-buttons">
            <button id="btn-fuel-stations" class="active" data-collection="fuelStations">á‹¨áˆ›á‹°á‹« áˆ˜áˆ¨áŒƒá‹á‰½</button>
            <button id="btn-tip-offs" data-collection="tipOffs">á‹¨á‰°á‹˜áŒ‰ áˆ˜áŠ•áŒˆá‹¶á‰½</button>
            <button id="btn-community" data-collection="communityPosts">á‹¨áˆ›áˆ…á‰ áˆ¨áˆ°á‰¥ áˆáŒ¥áá‰½</button>
        </div>
        
    </header>

    <main class="container">
        <section class="data-display-section">
            <h2 id="sectionTitle">á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ á‹¨áˆ›á‹°á‹« áˆ˜áˆ¨áŒƒá‹á‰½</h2>
            <div id="dataContainer" class="stations-list">
                <p class="loading-message">áˆ˜áˆ¨áŒƒá‹á‰½ áŠ¥á‹¨á‰°áŒ«áŠ‘ áŠá‹...</p>
            </div>
            <button id="loadMoreButton" style="display: none;">á‰°áŒ¨áˆ›áˆª áˆ˜áˆ¨áŒƒ áŒ«áŠ•</button>
        </section>
    </main>

    <footer class="main-footer">
        <p>&copy; 2024 á‹µáˆ«á‹­á‰¨áˆ­ áˆ˜áˆ¨áŒƒ. áˆáˆ‰áˆ áˆ˜á‰¥á‰¶á‰½ á‹¨á‰°áŒ á‰ á‰ áŠ“á‰¸á‹á¢</p>
    </footer>

    <script type="module">
        // --- Firebase Imports (áŠ¨áŠá‰ áˆ©á‰µ áŒˆáŒ¾á‰½ á‹¨á‰°á‹ˆáˆ°á‹°) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit, doc, updateDoc, deleteDoc, addDoc, where, startAfter, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration (áŠ¨áŠá‰ áˆ©á‰µ áŒˆáŒ¾á‰½ á‹¨á‰°á‹ˆáˆ°á‹°) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-ywRuhanxoEJgR83jwp_-nOkPY4jLOH4",
            authDomain: "elanyas-info.firebaseapp.com",
            projectId: "elanyas-info",
            storageBucket: "elanyas-info.firebasestorage.app",
            messagingSenderId: "769306910360",
            appId: "1:769306910360:web:70988eed5b1da5ffa0faed",
            measurementId: "G-2XX2B3RSGP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Global State Variables for Pagination (áˆ›áˆµá‰°áŠ«áŠ¨á‹« 6) ---
        const ITEMS_PER_PAGE = 10; // á‰ á‹¨áŒŠá‹œá‹ á‹¨áˆšáŒ«áŠá‹ á‹¨áˆ˜áˆ¨áŒƒ á‰¥á‹›á‰µ
        let currentCollection = 'fuelStations';
        let lastVisible = null;
        let isLoading = false;
        
        const dataContainer = document.getElementById('dataContainer');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const sectionTitle = document.getElementById('sectionTitle');

        // --- Utility Functions ---

        // TimeAgo function (áŠ¨áŠá‰ áˆ©á‰µ áŒˆáŒ¾á‰½ á‹¨á‰°á‹ˆáˆ°á‹°)
        function timeAgo(date) {
            if (!date) return 'á‹«áˆá‰³á‹ˆá‰€';
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) { const value = Math.floor(interval); return value + " " + (value === 1 ? "á‹“áˆ˜á‰µ" : "á‹“áˆ˜á‰³á‰µ") + " á‰ áŠá‰µ"; }
            interval = seconds / 2592000;
            if (interval > 1) { const value = Math.floor(interval); return value + " " + (value === 1 ? "á‹ˆáˆ­" : "á‹ˆáˆ«á‰µ") + " á‰ áŠá‰µ"; }
            interval = seconds / 86400;
            if (interval > 1) { const value = Math.floor(interval); return value + " " + (value === 1 ? "á‰€áŠ•" : "á‰€áŠ“á‰µ") + " á‰ áŠá‰µ"; }
            interval = seconds / 3600;
            if (interval > 1) { const value = Math.floor(interval); return value + " " + (value === 1 ? "áˆ°á‹“á‰µ" : "áˆ°á‹“á‰³á‰µ") + " á‰ áŠá‰µ"; }
            interval = seconds / 60;
            if (interval > 1) { const value = Math.floor(interval); return value + " " + (value === 1 ? "á‹°á‰‚á‰ƒ" : "á‹°á‰‚á‰ƒá‹á‰½") + " á‰ áŠá‰µ"; }
            return "áŠ¨áŒ¥á‰‚á‰µ áˆ°áŠ¨áŠ•á‹¶á‰½ á‰ áŠá‰µ";
        }
        
        // Function to check and ban user (áŠ¨áŠá‰ áˆ©á‰µ áŒˆáŒ¾á‰½ á‹¨á‰°á‹ˆáˆ°á‹°)
        async function checkAndBanUser(phoneNumber) {
            try {
                const falspostQuery = query(collection(db, "falspost"), where("phoneNumber", "==", phoneNumber));
                const falspostSnapshot = await getDocs(falspostQuery);

                if (falspostSnapshot.size >= 3) {
                    const banusersRef = collection(db, "banusers");
                    const banQuery = query(banusersRef, where("phoneNumber", "==", phoneNumber));
                    const banSnapshot = await getDocs(banQuery);

                    if (banSnapshot.empty) {
                        await addDoc(banusersRef, {
                            phoneNumber: phoneNumber,
                            bannedAt: new Date()
                        });
                        alert(`á‰°áŒ á‰ƒáˆš ${phoneNumber} á‰ á‰°á‹°áŒ‹áŒ‹áˆš á‹¨á‰°áˆ³áˆ³á‰° áˆ˜áˆ¨áŒƒ á‰ áˆ˜áˆˆáŒ á‰ á‰°áŒˆá‹µá‰§áˆá¢`);
                    }
                }
            } catch (error) {
                console.error("Error checking or banning user:", error);
            }
        }
        
        // --- Core Data Fetching Function (áˆ›áˆµá‰°áŠ«áŠ¨á‹« 5 áŠ¥áŠ“ 6) ---
        async function fetchInitialData(collectionName) {
            if (isLoading) return;
            isLoading = true;
            
            sectionTitle.textContent = getTitleForCollection(collectionName);
            dataContainer.innerHTML = '<p class="loading-message">áˆ˜áˆ¨áŒƒá‹á‰½ áŠ¥á‹¨á‰°áŒ«áŠ‘ áŠá‹...</p>';
            loadMoreButton.style.display = 'none';
            lastVisible = null;

            try {
                const q = query(
                    collection(db, collectionName), 
                    orderBy("timestamp", "desc"), 
                    limit(ITEMS_PER_PAGE)
                );
                
                const querySnapshot = await getDocs(q);
                dataContainer.innerHTML = ''; 

                if (querySnapshot.empty) {
                    dataContainer.innerHTML = `<p class="loading-message">áˆáŠ•áˆ ${getTitleForCollection(collectionName).replace('á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ ', '')} áŠ áˆá‰°áŒˆáŠ˜áˆá¢</p>`;
                    isLoading = false;
                    return;
                }

                displayData(querySnapshot.docs);

                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                // áŠ¨á‰°áŒ«áŠ‘á‰µ á‹«áŠáˆ° áˆ˜áˆ¨áŒƒ áŠ«áˆˆ á‰°áŒ¨áˆ›áˆª á‹¨áˆ˜áŒ«áŠ› áŠ á‹áˆ«áˆ© áŠ á‹­á‰³á‹­áˆ
                if (querySnapshot.docs.length === ITEMS_PER_PAGE) {
                    loadMoreButton.style.display = 'block';
                }

            } catch (error) {
                console.error("Error fetching initial data:", error);
                dataContainer.innerHTML = `<p class="loading-message" style="color: #f44336;">áˆ˜áˆ¨áŒƒá‹á‰½áŠ• á‰ áˆ˜áŒ«áŠ• áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ¥áˆ¯áˆ: ${error.message}</p>`;
            } finally {
                isLoading = false;
            }
        }
        
        async function fetchMoreData() {
            if (isLoading || !lastVisible) return;
            isLoading = true;
            loadMoreButton.disabled = true;
            loadMoreButton.textContent = 'á‰ áˆ˜áŒ«áŠ• áˆ‹á‹­...';

            try {
                const q = query(
                    collection(db, currentCollection), 
                    orderBy("timestamp", "desc"), 
                    startAfter(lastVisible),
                    limit(ITEMS_PER_PAGE)
                );
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    loadMoreButton.style.display = 'none';
                    dataContainer.insertAdjacentHTML('beforeend', '<p class="loading-message">áˆáˆ‰áˆ áˆ˜áˆ¨áŒƒá‹á‰½ á‰°áŒ­áŠá‹‹áˆá¢</p>');
                    isLoading = false;
                    return;
                }

                displayData(querySnapshot.docs);

                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                if (querySnapshot.docs.length < ITEMS_PER_PAGE) {
                    loadMoreButton.style.display = 'none';
                    dataContainer.insertAdjacentHTML('beforeend', '<p class="loading-message">áˆáˆ‰áˆ áˆ˜áˆ¨áŒƒá‹á‰½ á‰°áŒ­áŠá‹‹áˆá¢</p>');
                }

            } catch (error) {
                console.error("Error fetching more data:", error);
                alert("á‰°áŒ¨áˆ›áˆª áˆ˜áˆ¨áŒƒ á‰ áˆ˜áŒ«áŠ• áˆ‹á‹­ áˆµáˆ…á‰°á‰µ á‰°áˆáŒ¥áˆ¯áˆá¢");
            } finally {
                isLoading = false;
                loadMoreButton.disabled = false;
                loadMoreButton.textContent = 'á‰°áŒ¨áˆ›áˆª áˆ˜áˆ¨áŒƒ áŒ«áŠ•';
            }
        }
        
        // --- Data Rendering Function ---
        function getTitleForCollection(collectionName) {
            switch(collectionName) {
                case 'fuelStations': return 'á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ á‹¨áˆ›á‹°á‹« áˆ˜áˆ¨áŒƒá‹á‰½';
                case 'tipOffs': return 'á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ á‹¨á‰°á‹˜áŒ‰ á‹¨áˆ˜áŠ•áŒˆá‹µ áŒ¥á‰†áˆ›á‹á‰½';
                case 'communityPosts': return 'á‹¨á‰…áˆ­á‰¥ áŒŠá‹œ áˆ›áˆ…á‰ áˆ¨áˆ°á‰¥ áˆáŒ¥áá‰½';
                default: return 'á‹¨áˆ˜áˆ¨áŒƒ á‹áˆ­á‹áˆ®á‰½';
            }
        }

        function displayData(docs) {
            dataContainer.className = ''; // Clear previous grid styles
            
            docs.forEach(docSnap => {
                const data = docSnap.data();
                const id = docSnap.id;
                // Check if timestamp is a Firebase Timestamp object and convert it
                const dateObject = data.timestamp && typeof data.timestamp.toDate === 'function' ? data.timestamp.toDate() : null;
                const postedTime = dateObject ? timeAgo(dateObject) : 'á‹«áˆá‰³á‹ˆá‰€';
                const likes = data.likes || [];
                const dislikes = data.dislikes || [];
                
                if (currentCollection === 'fuelStations') {
                    dataContainer.classList.add('stations-list');
                    const fuelStatusClass = data.fuelStatus === "áŠ áˆˆ" ? "available" : (data.fuelStatus === "áŠ áŠáˆµá‰°áŠ›" ? "low" : "unavailable");
                    const queueStatusClass = data.queueStatus === "á‹¨áˆˆáˆ" ? "no-queue" : (data.queueStatus === "áŠ áŒ­áˆ­" ? "short-queue" : (data.queueStatus === "áˆ˜áŠ«áŠ¨áˆˆáŠ›" ? "medium-queue" : "long-queue"));
                    
                    const card = document.createElement('div');
                    card.className = 'station-card';
                    card.innerHTML = `
                        <h3>${data.stationName || 'á‹«áˆá‰³á‹ˆá‰€ áˆ›á‹°á‹«'}</h3>
                        <p><strong>á‹¨áŠá‹³áŒ… áŠ á‹­áŠá‰µ:</strong> ${data.fuelType || 'áŠ áˆá‰°áŒˆáˆˆáŒ¸áˆ'}</p>
                        <p><strong>á‹¨áŠá‹³áŒ… áˆáŠ”á‰³:</strong> <span class="status-indicator ${fuelStatusClass}">${data.fuelStatus || 'á‹¨áˆˆáˆ'}</span></p>
                        <p><strong>á‹¨á‹ˆáˆ¨á‹ áˆáŠ”á‰³:</strong> <span class="status-indicator ${queueStatusClass}">${data.queueStatus || 'áˆ¨áŒ…áˆ'}</span></p>
                        <p><strong>áˆ˜áˆ¨áŒƒ á‹¨áˆˆáŒ áˆá‹:</strong> ${data.submittedBy || 'á‹«áˆá‰³á‹ˆá‰€'}</p>
                        <p><strong>á‹¨á‰°áˆˆáŒ áˆá‰ á‰µ á‰€áŠ•:</strong> ${postedTime}</p>
                        
                        <div class="vote-controls">
                            <button class="like-button ${likes.includes(loggedInUserPhone) ? 'liked' : ''}" data-id="${id}" data-collection="fuelStations">ğŸ‘ <span class="like-count">${likes.length}</span></button>
                            <button class="dislike-button ${dislikes.includes(loggedInUserPhone) ? 'disliked' : ''}" data-id="${id}" data-collection="fuelStations">ğŸ‘ <span class="dislike-count">${dislikes.length}</span></button>
                        </div>
                    `;
                    dataContainer.appendChild(card);

                } else if (currentCollection === 'communityPosts') {
                    dataContainer.classList.add('posts-container');
                    const displayAuthorName = data.authorName || 'á‹«áˆá‰³á‹ˆá‰€';

                    const card = document.createElement('div');
                    card.className = 'community-post-card';
                    card.innerHTML = `
                        <h3>${data.title || 'á‹«áˆá‰³á‹ˆá‰€ áˆ­á‹•áˆµ'}</h3>
                        <p><strong>á‹¨áˆˆáŒ áˆá‹:</strong> ${displayAuthorName}</p>
                        <p class="post-content">${data.content || 'á‹­á‹˜á‰µ á‹¨áˆˆáˆ'}</p>
                        <p><strong>á‹¨á‰°áˆˆáŒ áˆá‰ á‰µ á‰€áŠ•:</strong> ${postedTime}</p>
                        
                        <div class="vote-controls">
                            <button class="like-button ${likes.includes(loggedInUserPhone) ? 'liked' : ''}" data-id="${id}" data-collection="communityPosts">ğŸ‘ <span class="like-count">${likes.length}</span></button>
                            <button class="dislike-button ${dislikes.includes(loggedInUserPhone) ? 'disliked' : ''}" data-id="${id}" data-collection="communityPosts">ğŸ‘ <span class="dislike-count">${dislikes.length}</span></button>
                        </div>
                    `;
                    dataContainer.appendChild(card);
                    
                } else if (currentCollection === 'tipOffs') {
                    // *** á‹¨á‰°á‹˜áŒ‰ á‹¨áˆ˜áŠ•áŒˆá‹µ áŒ¥á‰†áˆ›á‹á‰½ (tipOffs) áˆ›áˆ»áˆ»á‹«á¡ áˆ˜áˆ°áˆ¨á‹áŠ•/áŠ¥áŒá‹µáŠ• á‹¨áˆšá‹«áˆµáŠ¨á‰µáˆ áˆáŒ‚áŠ­ á‰°á‹ˆáŒá‹·áˆ ***
                    dataContainer.classList.add('tip-offs-list');
                    const submittedBy = data.submittedBy || 'á‹«áˆá‰³á‹ˆá‰€ á‰°áŒ á‰ƒáˆš'; 
                    
                    const card = document.createElement('div');
                    card.className = 'tip-off-card'; 
                    
                    card.innerHTML = `
                        <h3 class="tip-location">${data.location || 'á‹«áˆá‰³á‹ˆá‰€ á‰¦á‰³'}</h3>
                        <p class="tip-details"><strong>á‹áˆ­á‹áˆ­:</strong> ${data.details || 'á‹áˆ­á‹áˆ­ áŠ áˆá‰°áŒˆáˆˆáŒ¸áˆ'}</p>
                        <p class="tip-meta">á‹¨á‰°áˆ‹áŠ¨á‹ á‰ : <strong>${submittedBy}</strong></p>
                        <p class="tip-meta">á‹¨á‰°á‹˜áˆ˜áŠ á‰ : ${postedTime}</p>
                        
                        <div class="vote-controls">
                            <button class="like-button ${likes.includes(loggedInUserPhone) ? 'liked' : ''}" data-id="${id}" data-collection="tipOffs">á‰°á‹˜áŒá‰·áˆ<span class="like-count">${likes.length}</span></button>
                            <button class="dislike-button ${dislikes.includes(loggedInUserPhone) ? 'disliked' : ''}" data-id="${id}" data-collection="tipOffs">á‰°áŠ¨áá‰·áˆ<span class="dislike-count">${dislikes.length}</span></button>
                        </div>
                    `;
                    dataContainer.appendChild(card);
                }
            });
            
            // Re-attach event listeners after rendering new cards
            attachVoteListeners();
        }
        
        // --- Voting Logic (áˆ›áˆµá‰°áŠ«áŠ¨á‹« 3) ---
        async function handleVote(event, type) {
            // Check if user is logged in
            if (!loggedInUserPhone) {
                alert("áˆˆá‹µáˆá… áˆ˜áˆµáŒ á‰µ áˆ˜áŒá‰£á‰µ áŠ áˆˆá‰¥á‹á‰µá¢");
                return;
            }
            
            const button = event.currentTarget;
            const postId = button.dataset.id;
            const collectionName = button.dataset.collection;
            
            const postRef = doc(db, collectionName, postId);

            try {
                const docSnap = await getDoc(postRef); 
                if (!docSnap.exists()) {
                    alert("áˆ˜áˆ¨áŒƒá‹ áŠ áˆá‰°áŒˆáŠ˜áˆá¢");
                    fetchInitialData(currentCollection);
                    return;
                }

                const data = docSnap.data();
                const currentLikes = data.likes || [];
                const currentDislikes = data.dislikes || [];
                // The phone number of the user who posted the data (used for banning)
                const postAuthor = data.author || data.submittedBy || null; 

                let newLikes = [...currentLikes];
                let newDislikes = [...currentDislikes];

                const isAlreadyLiked = newLikes.includes(loggedInUserPhone);
                const isAlreadyDisliked = newDislikes.includes(loggedInUserPhone);

                // --- Vote Toggling Logic ---
                if (type === 'like') {
                    if (isAlreadyLiked) {
                        newLikes = newLikes.filter(phone => phone !== loggedInUserPhone);
                        button.classList.remove('liked');
                    } else {
                        newLikes.push(loggedInUserPhone);
                        button.classList.add('liked');
                        if (isAlreadyDisliked) {
                            newDislikes = newDislikes.filter(phone => phone !== loggedInUserPhone);
                            // Also update the UI for the disliked button on the same card
                            document.querySelector(`.dislike-button[data-id="${postId}"]`).classList.remove('disliked');
                        }
                    }
                } else if (type === 'dislike') {
                    if (isAlreadyDisliked) {
                        newDislikes = newDislikes.filter(phone => phone !== loggedInUserPhone);
                        button.classList.remove('disliked');
                    } else {
                        newDislikes.push(loggedInUserPhone);
                        button.classList.add('disliked');
                        if (isAlreadyLiked) {
                            newLikes = newLikes.filter(phone => phone !== loggedInUserPhone);
                             // Also update the UI for the liked button on the same card
                            document.querySelector(`.like-button[data-id="${postId}"]`).classList.remove('liked');
                        }
                    }
                }

                await updateDoc(postRef, {
                    likes: newLikes,
                    dislikes: newDislikes
                });

                // Update counts on the page directly
                document.querySelector(`.like-button[data-id="${postId}"] .like-count`).textContent = newLikes.length;
                document.querySelector(`.dislike-button[data-id="${postId}"] .dislike-count`).textContent = newDislikes.length;

                // --- Automated Deletion and Ban Logic (Applies ONLY to fuelStations and communityPosts) ---
                if (collectionName !== 'tipOffs' && newDislikes.length >= 5) {
                    // Check if the post meets the deletion criteria
                    if (!(newLikes.length >= 15 && newDislikes.length >= 10)) {
                        await deleteDoc(postRef); 
                        alert("áˆ˜áˆ¨áŒƒá‹ á‰ á‰°á‹°áŒ‹áŒ‹áˆš á‹²áˆµáˆ‹á‹­áŠ­ á‰ áˆ˜á‹°áˆ¨áŒ‰ á‰°áˆ°áˆ­á‹Ÿáˆá¢");

                        if (postAuthor) {
                             await addDoc(collection(db, "falspost"), {
                                phoneNumber: postAuthor,
                                reason: `${collectionName} Deleted due to excessive dislikes`,
                                timestamp: new Date()
                            });
                            await checkAndBanUser(postAuthor);
                        }
                        // Refresh list after deletion
                        fetchInitialData(currentCollection); 
                    }
                }

            } catch (error) {
                console.error("Vote operation failed:", error);
                alert("á‹µáˆá… áˆˆáˆ˜áˆµáŒ á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¢ áŠ¥á‰£áŠ­á‹ áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆáŠ­áˆ©á¢");
            }
        }
        
        function attachVoteListeners() {
            // Remove previous listeners to prevent multiple execution
            document.querySelectorAll('.like-button').forEach(button => {
                button.removeEventListener('click', (e) => handleVote(e, 'like'));
            });
            document.querySelectorAll('.dislike-button').forEach(button => {
                button.removeEventListener('click', (e) => handleVote(e, 'dislike'));
            });
            
            // Attach new listeners
            document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', (e) => handleVote(e, 'like'));
            });
            document.querySelectorAll('.dislike-button').forEach(button => {
                button.addEventListener('click', (e) => handleVote(e, 'dislike'));
            });
        }

        // --- Event Handlers ---
        
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.navigation-buttons button');
            
            // Button Click Handler
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newCollection = button.dataset.collection;
                    
                    // Update active button style
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    if (currentCollection !== newCollection) {
                        currentCollection = newCollection;
                        fetchInitialData(currentCollection);
                    }
                });
            });
            
            // Load More Button Handler (Scroll event for auto-load is not implemented, using the explicit button as requested)
            loadMoreButton.addEventListener('click', fetchMoreData);
            
            // Initial data load (Default to fuelStations)
            fetchInitialData('fuelStations');
        });
        
    </script>
    <script src="main.js"></script>
</body>
</html>