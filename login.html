<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>የባጃጅ ነዳጅ መረጃ - መግቢያ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GW2Y1BE243"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GW2Y1BE243');
    </script>
</head>
<body>
    <div class="main-container">
        <div class="login-section">
            <div class="login-form-card">
                <h2 class="form-title">እንኳን ደህና መጡ!</h2>
                <p class="form-subtitle">በስልክ ቁጥርዎ እና በይለፍቃልዎ ይግቡ።</p>
                
                <div class="input-group">
                    <label for="phoneNumberInput" class="sr-only">ስልክ ቁጥር:</label>
                    <input type="tel" id="phoneNumberInput" placeholder="ስልክ ቁጥር (ለምሳሌ: 0912345678)" required>
                </div>
                <div class="input-group">
                    <label for="licensePlateInput" class="sr-only">የይለፍ ቃል:</label>
                    <input type="text" id="licensePlateInput" placeholder="የይለፍ ቃል (ለምሳሌ: 1234)" required>
                </div>
                
                <button id="loginButton">መግቢያ</button>
                
                <p id="errorMessage" class="error-message"></p>
            </div>
        </div>

        <div class="info-container">
            <h2 class="info-title">ለሹፌሮች ወሳኝ መረጃ!</h2>
            <p><strong>ውድ የባጃጅ ሹፌሮች፣ ይህ ድረ-ገጽ የዕለት ተዕለት የሹፍርና ስራችሁን ለማቀላጠፍ እና አስፈላጊ መረጃዎችን በፍጥነት እንድታገኙ ታስቦ የተሰራ ነው።</strong> </p>

<p>በእኛ መድረክ የሚከተሉትን ማግኘት ትችላላችሁ: </p>

<p><strong>• የነዳጅ ማደያ ወቅታዊ መረጃ: </strong>የነዳጅ መኖር/አለመኖር፣ የነዳጅ አይነት፣ የዋጋ ግምት እና የወረፋ ሁኔታ መረጃ በእጃችሁ ይገኛል። </p>

<p><strong>• የማህበረሰብ ልውውጥ: </strong>ሌሎች የባጃጅ ሹፌሮች እና ባለቤቶች የሚለጥፏቸውን ተሞክሮዎች፣ ጠቃሚ ምክሮች እና ጥያቄዎች ማየትና መሳተፍ ይችላሉ። </p>

<p><strong>• መሰረታዊ የባጃጅ ጥገና ምክሮች:</strong> ባጃጃችሁን በጥሩ ሁኔታ ለመጠበቅ የሚረዱ ጠቃሚ የእንክብካቤ መመሪያዎች። </p>

<p><strong>• የመንገድ ትራንስፖርት መረጃዎች:</strong> አዳዲስ ህጎች፣ ደንቦች እና አጠቃላይ የትራንስፖርት ዜናዎች። </p>

<p><strong>• ያገለገሉ የባጃጅ ሽያጭ መረጃዎች: </strong>ባጃጅ ለመግዛትም ሆነ ለመሸጥ የምትፈልጉ ከሆነ ጠቃሚ መረጃዎችን ታገኛላችሁ። </p>

<p>ይግቡና የአገልግሎታችን ተጠቃሚ ይሁኑ!</p>

 <h2 class="info-title"></h2>

            <div class="info-section">
                <h3 class="section-heading">ይህንን ድረ-ገጽ ለምን መጠቀም አለባችሁ? ዋና ዋና ምክንያቶች:</h3>
                <ul>
                    <li><p><strong>ጊዜ ለመቆጠብ:</strong> ወደ ነዳጅ ማደያ ከመሄድዎ በፊት ሁኔታውን በማየት ወረፋ ያለበትን ወይም ነዳጅ የሌለበትን ቦታ ለማወቅ ይረዳዎታል።</p></li>
                    <li><p><strong>ገንዘብ ለመቆጠብ:</strong> አላስፈላጊ ጉዞዎችን ይቀንሳሉ፣ ይህም ነዳጅዎን እና ጉልበትዎን ይቆጥባል።</p></li>
                    <li><p><strong>ለመረጃ ልውውጥ:</strong> ማነኛውንም መረጃ እርስ በእርስ ለመለዋወጥ እና የባጃጅ ማህበረሰብ አካል ለመሆን ያስችልዎታል።</p></li>
                    <li><p><strong>በፍጥነት ለመወሰን:</strong> የትኛው ማደያ የተሻለ እንደሆነ ፈጣንና ትክክለኛ ውሳኔ እንዲወስኑ ያስችልዎታል።</p></li>
                </ul>
            </div>

            <div class="info-section">
                <h3 class="section-heading">የአጠቃቀም መመሪያ:</h3>
                <ol>
                    <li><p>በመጀመሪያ፣ ወደ ስልክ ቁጥር <strong>0989750238</strong> በE-birr በቀላሉ <strong> ወርሀዊ ክፍያ 50 ብር</strong> ይክፈሉ።</p></li>
                    <li><p>በመቀጠል፣  የክፍያ ማረጋገጫውን <strong>ስክሪንሾት</strong> ያንሱ። </p></li>
                    <li><p> ከታች ያለውን በተን በመጫን ወደ <span class="telegram-link-text">ቴሌግራም ቦት</span> ለይ ይሂዱ። የሚጠየቁትን መረጃም ይስጡ።</p></li>
                    <li><p>በትክክል መክፈልዎ ከተረጋገጠ በኋላ ቦቱ አገልግሎቱን ይሰጥዎታል። <strong>ይህ ማለት ዌብሳይቱን መጠቀም ይችላሉ ማለት ነው።</strong> </p></li>
                </ol>
                <div class="telegram-button-container">
                    <a href="https://t.me/elan_payment_bot" target="_blank" class="telegram-button"><strong>ቴሌግራም ቦት</strong></a>
                </div>
            </div>
            <p class="important-note"><strong> ድረ-ገጹ ስራዎን ለማቃለል እና ወጪዎን ለመቀነስ እንደሚረዳዎ እርግጠኞች ነን!</strong></p>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"; // Added getAuth and signInWithCustomToken

    const firebaseConfig = {
        apiKey: "AIzaSyA-ywRuhanxoEJgR83jwp_-nOkPY4jLOH4",
        authDomain: "elanyas-info.firebaseapp.com",
        projectId: "elanyas-info",
        storageBucket: "elanyas-info.firebasestorage.app",
        messagingSenderId: "769306910360",
        appId: "1:769306910360:web:70988eed5b1da8ffa0faed",
        measurementId: "G-2XX2B3RSGP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // Initialize Auth

    const phoneNumberInput = document.getElementById('phoneNumberInput');
    const licensePlateInput = document.getElementById('licensePlateInput');
    const loginButton = document.getElementById('loginButton');
    const errorMessageDisplay = document.getElementById('errorMessage');

    function showErrorMessage(message) {
        errorMessageDisplay.textContent = message;
        errorMessageDisplay.style.opacity = "1";
    }

    function hideErrorMessage() {
        errorMessageDisplay.style.opacity = "0";
        errorMessageDisplay.textContent = "";
    }

    // Check for existing error message from data.html
    document.addEventListener('DOMContentLoaded', () => {
        const storedErrorMessage = localStorage.getItem('errorMessageOnLoad');
        if (storedErrorMessage) {
            showErrorMessage(storedErrorMessage);
            localStorage.removeItem('errorMessageOnLoad'); // Once displayed, remove it
        }
    });


    loginButton.addEventListener('click', async () => {
        hideErrorMessage();

        const phoneNumber = phoneNumberInput.value.trim();
        const licensePlate = licensePlateInput.value.trim(); // የታርጋ ቁጥርን Trim አድርግ

        if (!phoneNumber || !licensePlate) {
            showErrorMessage("እባክዎ ሁሉንም መስኮች ይሙሉ!");
            return;
        }
        if ((!phoneNumber.startsWith('09') && !phoneNumber.startsWith('07')) || phoneNumber.length !== 10 || !/^\d+$/.test(phoneNumber)) {
            showErrorMessage("ትክክለኛ የኢትዮጵያ ስልክ ቁጥር ያስገቡ (ለምሳሌ: 0912345678)");
            return;
        }

        loginButton.disabled = true;
        showErrorMessage("እየገቡ ነው... እባክዎ ይጠብቁ።");

        try {
            // Document ID በቦቱ የተቀመጠበትን ፎርማት ተጠቀም
            const userDocId = `${phoneNumber}-${licensePlate.toUpperCase()}`;
            
            const userDocRef = doc(db, "users", userDocId);
            const userSnapshot = await getDoc(userDocRef);

            if (!userSnapshot.exists()) {
                showErrorMessage("ስልክ ቁጥርዎ ወይም የይለፍ ቃልዎ ትክክል አይደለም ወይም አልተመዘገቡም።");
                loginButton.disabled = false;
                return;
            }

            const userData = userSnapshot.data();
            // registered_status እዚህ ጋር መኖሩን እና true መሆኑን ያረጋግጡ
            if (!userData.registered_status) {
                showErrorMessage("ለመግባት አልተፈቀደልዎትም። እባክዎ የአድሚን ማረጋገጫ ይጠብቁ።");
                loginButton.disabled = false;
                return;
            }

            // የገባው የታርጋ ቁጥር በ Firebase ውስጥ ካለው ጋር መመሳሰሉን ያረጋግጡ
            // የታርጋ ቁጥሩን ወደ UPPERCASE ቀይረን ማወዳደር ወጥነት ይሰጣል
            if (userData.license_plate !== licensePlate.toUpperCase()) {
                 showErrorMessage("ስልክ ቁጥርዎ ወይም የይለፍ ቃልዎ ትክክል አይደለም።");
                 loginButton.disabled = false;
                 return;
            }

            // Check subscription expiration here as well
            const SUBSCRIPTION_DURATION_DAYS = 30; // የደንበኝነት ምዝገባው የሚቆይበት ጊዜ በ ቀናት
            const lastPaymentDate = userData.last_payment_date ? new Date(userData.last_payment_date.toDate()) : null;

            if (!lastPaymentDate) {
                showErrorMessage("የክፍያ መረጃ የለም። እባክዎ ክፍያ ይፈጽሙ።");
                loginButton.disabled = false;
                return;
            }

            const today = new Date();
            const expirationDate = new Date(lastPaymentDate);
            expirationDate.setDate(expirationDate.getDate() + SUBSCRIPTION_DURATION_DAYS);

            if (today > expirationDate) {
                showErrorMessage("የደንበኝነት ምዝገባ ጊዜዎ አልቋል። እባክዎ ያድሱ።");
                loginButton.disabled = false;
                return;
            }


            // If all checks pass, sign in to Firebase Auth using a custom token.
            // **IMPORTANT:** You need a backend (like a Cloud Function or your Python bot)
            // to generate this custom token securely. For now, we'll simulate it.
            // In a real app, you'd make an API call to your backend here to get the token.
            // For simplicity and proof of concept, we'll store user credentials in localStorage
            // and use them directly for subsequent checks. The Firebase Auth part for signInWithCustomToken
            // is commented out as it requires a server-side token generation.

            // Since you're not using email/password or phone auth directly from client,
            // we will stick to Local Storage and Firestore checks for now.
            // The onAuthStateChanged in data.html will need adjustment.

            localStorage.setItem('isLoggedIn', 'true'); // የመግቢያ ሁኔታን በ Local Storage ውስጥ አስቀምጥ
            localStorage.setItem('loggedInUserName', userData.full_name || 'ያልታወቀ ተጠቃሚ');
            localStorage.setItem('loggedInUserPhone', phoneNumber); 
            localStorage.setItem('loggedInUserLicensePlate', licensePlate.toUpperCase()); // Store license plate for data.html check
            // የጨመርኩት መስመር: የመጨረሻውን የክፍያ ቀን በሎካል ስቶሬጅ ማስቀመጥ
// Firebase Timestamp object ከሆነ ወደ ISO string እንቀይረዋለን
if (userData.last_payment_date && typeof userData.last_payment_date.toDate === 'function') {
    localStorage.setItem('loggedInUserLastPaymentDate', userData.last_payment_date.toDate().toISOString());
} else if (userData.last_payment_date) {
    // If it's already a date string or another format, store as is
    localStorage.setItem('loggedInUserLastPaymentDate', userData.last_payment_date);
} else {
    localStorage.removeItem('loggedInUserLastPaymentDate'); // If no date, ensure it's not stored
}
            
            alert("በተሳካ ሁኔታ ገብተዋል!");
            window.location.href = "data.html"; // ወደ ዋናው ገጽ ምራ

        } catch (error) {
            console.error("Error during login:", error);
            showErrorMessage("በመግባት ላይ ችግር ተፈጥሯል። እባክዎ እንደገና ይሞክሩ።");
            loginButton.disabled = false;
        }
    });
</script>
</body>
</html>