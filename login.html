<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>የባጃጅ ነዳጅ መረጃ - መግቢያ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GW2Y1BE243"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GW2Y1BE243');
    </script>
</head>
<body>
    <div class="main-container">
        <div class="login-section">
            <div class="login-form-card">
                <h2 class="form-title">እንኳን ደህና መጡ!</h2>
                <p class="free-trial-info">
                    <b> የነጻ ምዝገባ ላይ ነን!</b>
                    በዚህ ጊዜ የምትመዘገቡ ከሆነ የክፍያ ማረጋገጫ ሳያስፈልግዎ የዌብሳይቱን አገልግሎት መጠቀም ይችላሉ።
                </p>
                <p class="form-subtitle">በስልክ ቁጥርዎ እና በይለፍቃልዎ ይግቡ።</p>
                
                <div class="input-group">
                    <label for="phoneNumberInput" class="sr-only">ስልክ ቁጥር:</label>
                    <input type="tel" id="phoneNumberInput" placeholder="ስልክ ቁጥር (ለምሳሌ: 0912345678)" required>
                </div>
                <div class="input-group">
                    <label for="passwordInput" class="sr-only">የይለፍ ቃል:</label>
                    <input type="text" id="passwordInput" placeholder="የይለፍ ቃል (ለምሳሌ: 123456)" required>
                </div>
                
                <button id="loginButton">መግቢያ</button>
                
                <p id="errorMessage" class="error-message"></p>

                <p class="forgot-password-link" style="display: none;">
                    የይለፍ ቃልዎን ረሱ? <a href="#" id="forgotPasswordTrigger">እዚህ ይጫኑ</a>
                </p>
            </div>
        </div>

        <div class="info-container">
            <h2 class="info-title">ለሹፌሮች ወሳኝ መረጃ!</h2>
            <p><strong>ውድ የባጃጅ ሹፌሮች፣ ይህ ድረ-ገጽ የዕለት ተዕለት የሹፍርና ስራችሁን ለማቀላጠፍ እና አስፈላጊ መረጃዎችን በፍጥነት እንድታገኙ ታስቦ የተሰራ ነው።</strong> </p>

            <p>በእኛ መድረክ የሚከተሉትን ማግኘት ትችላላችሁ: </p>

            <p><strong>• የነዳጅ ማደያ ወቅታዊ መረጃ: </strong>የነዳጅ መኖር/አለመኖር፣ የነዳጅ አይነት፣ የዋጋ ግምት እና የወረፋ ሁኔታ መረጃ በእጃችሁ ይገኛል። </p>

            <p><strong>• የማህበረሰብ ልውውጥ: </strong>ሌሎች የባጃጅ ሹፌሮች እና ባለቤቶች የሚለጥፏቸውን ተሞክሮዎች፣ ጠቃሚ ምክሮች እና ጥያቄዎች ማየትና መሳተፍ ይችላሉ። </p>

            <p><strong>• መሰረታዊ የባጃጅ ጥገና ምክሮች:</strong> ባጃጃችሁን በጥሩ ሁኔታ ለመጠበቅ የሚረዱ ጠቃሚ የእንክብካቤ መመሪያዎች። </p>

            <p><strong>• የመንገድ ትራንስፖርት መረጃዎች:</strong> አዳዲስ ህጎች፣ ደንቦች እና አጠቃላይ የትራንስፖርት ዜናዎች ማግኘት ትችላላችሁ። </p>

            <p><strong>• ያገለገሉ የባጃጅ ሽያጭ መረጃዎች: </strong>ባጃጅ ለመግዛትም ሆነ ለመሸጥ የምትፈልጉ ከሆነ ጠቃሚ መረጃዎችን ታገኛላችሁ። </p>

            <p>ይግቡና የአገልግሎታችን ተጠቃሚ ይሁኑ!</p>

            <h2 class="info-title"></h2>

            <div class="info-section">
                <h3 class="section-heading">ይህንን ድረ-ገጽ ለምን መጠቀም አለባችሁ? ዋና ዋና ምክንያቶች:</h3>
                <ul>
                    <li><p><strong>ጊዜ ለመቆጠብ:</strong> ወደ ነዳጅ ማደያ ከመሄድዎ በፊት ሁኔታውን በማየት ወረፋ ያለበትን ወይም ነዳጅ የሌለበትን ቦታ ለማወቅ ይረዳዎታል።</p></li>
                    <li><p><strong>ገንዘብ ለመቆጠብ:</strong> አላስፈላጊ ጉዞዎችን ይቀንሳሉ፣ ይህም ነዳጅዎን እና ጉልበትዎን ይቆጥባል።</p></li>
                    <li><p><strong>ለመረጃ ልውውጥ:</strong> ማነኛውንም መረጃ እርስ በእርስ ለመለዋወጥ እና የባጃጅ ማህበረሰብ አካል ለመሆን ያስችልዎታል።</p></li>
                    <li><p><strong>በፍጥነት ለመወሰን:</strong> የትኛው ማደያ የተሻለ እንደሆነ ፈጣንና ትክክለኛ ውሳኔ እንዲወስኑ ያስችልዎታል።</p></li>
                </ul>
            </div>

            <div class="info-section">
                <h3 class="section-heading">የአጠቃቀም መመሪያ:</h3>
                <p>
                    <b> የነጻ ምዝገባ ላይ ነን!</b>
                    በዚህ ጊዜ የምትመዘገቡ ከሆነ የክፍያ ማረጋገጫ ሳያስፈልግዎ የዌብሳይቱን አገልግሎት መጠቀም ይችላሉ።
                   <br>
                   <b> ነጻ ምዝገባ ለማድረግ: </b>ወደ ቴሌግራም ቦት ይሂዱ እና ሙሉ ስምዎን፣ የመረጡትን የይለፍ ቃል እና ስልክ ቁጥርዎን ይላኩ።
                    (ለምሳሌ: አበበ ከበደ, 1234, 0912345678)
                </p>
                <p>ከታች ያለውን በተን በመጫን ወደ <span class="telegram-link-text">ቴሌግራም ቦት</span> ላይ ይሂዱ።</p>
                <div class="telegram-button-container">
                    <a href="https://t.me/elan_payment_bot" target="_blank" class="telegram-button"><strong>ቴሌግራም ቦት</strong></a>
                </div>
            </div>
            <p class="important-note"><strong> ድረ-ገጹ ስራዎን ለማቃለል እና ወጪዎን ለመቀነስ እንደሚረዳዎ እርግጠኞች ነን!</strong></p>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"; 

    const firebaseConfig = {
        apiKey: "AIzaSyA-ywRuhanxoEJgR83jwp_-nOkPY4jLOH4",
        authDomain: "elanyas-info.firebaseapp.com",
        projectId: "elanyas-info",
        storageBucket: "elanyas-info.firebasestorage.app",
        messagingSenderId: "769306910360",
        appId: "1:769306910360:web:70988eed5b1da8ffa0faed",
        measurementId: "G-2XX2B3RSGP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const phoneNumberInput = document.getElementById('phoneNumberInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginButton = document.getElementById('loginButton');
    const errorMessageDisplay = document.getElementById('errorMessage');
    const forgotPasswordTrigger = document.getElementById('forgotPasswordTrigger');
    const forgotPasswordLinkContainer = document.querySelector('.forgot-password-link');

    let loginAttemptCount = 0; // To track failed login attempts

    function showErrorMessage(message) {
        errorMessageDisplay.textContent = message;
        errorMessageDisplay.style.opacity = "1";
    }

    function hideErrorMessage() {
        errorMessageDisplay.style.opacity = "0";
        errorMessageDisplay.textContent = "";
    }

    document.addEventListener('DOMContentLoaded', () => {
        const storedErrorMessage = localStorage.getItem('errorMessageOnLoad');
        if (storedErrorMessage) {
            showErrorMessage(storedErrorMessage);
            localStorage.removeItem('errorMessageOnLoad'); 
        }
    });

    loginButton.addEventListener('click', async () => {
        hideErrorMessage();

        const phoneNumber = phoneNumberInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!phoneNumber || !password) {
            showErrorMessage("እባክዎ ሁሉንም መስኮች ይሙሉ!");
            return;
        }
        if ((!phoneNumber.startsWith('09') && !phoneNumber.startsWith('07')) || phoneNumber.length !== 10 || !/^\d+$/.test(phoneNumber)) {
            showErrorMessage("ትክክለኛ የኢትዮጵያ ስልክ ቁጥር ያስገቡ (ለምሳሌ: 0912345678)");
            // Increment attempt count only if input is valid but credentials wrong
            loginAttemptCount++;
            if (loginAttemptCount >= 1) { // Show after 1st failed attempt
                forgotPasswordLinkContainer.style.display = 'block';
            }
            return;
        }

        loginButton.disabled = true;
        showErrorMessage("እየገቡ ነው... እባክዎ ይጠብቁ።");

        try {
            const userDocId = `${phoneNumber}-${password.toUpperCase()}`;
            
            const userDocRef = doc(db, "users", userDocId);
            const userSnapshot = await getDoc(userDocRef);

            if (!userSnapshot.exists()) {
                showErrorMessage("ስልክ ቁጥርዎ ወይም የይለፍ ቃልዎ ትክክል አይደለም ወይም አልተመዘገቡም።");
                loginAttemptCount++; // Increment attempt count
                if (loginAttemptCount >= 1) { // Show after 1st failed attempt
                    forgotPasswordLinkContainer.style.display = 'block';
                }
                loginButton.disabled = false;
                return;
            }

            const userData = userSnapshot.data();
            if (!userData.registered_status) {
                showErrorMessage("ለመግባት አልተፈቀደልዎትም። እባክዎ የአድሚን ማረጋገጫ ይጠብቁ።");
                loginAttemptCount++; // Increment attempt count
                if (loginAttemptCount >= 1) { // Show after 1st failed attempt
                    forgotPasswordLinkContainer.style.display = 'block';
                }
                loginButton.disabled = false;
                return;
            }

            if (userData.password !== password.toUpperCase()) {
                 showErrorMessage("ስልክ ቁጥርዎ ወይም የይለፍ ቃልዎ ትክክል አይደለም።");
                 loginAttemptCount++; // Increment attempt count
                 if (loginAttemptCount >= 1) { // Show after 1st failed attempt
                    forgotPasswordLinkContainer.style.display = 'block';
                 }
                 loginButton.disabled = false;
                 return;
            }

            // Check subscription expiration here
            const FREE_TRIAL_DURATION_DAYS = 15; 
            const PAID_SUBSCRIPTION_DURATION_DAYS = 30; 

            const createdDate = userData.created_at ? new Date(userData.created_at.toDate()) : null; 
            const lastPaymentDate = userData.last_payment_date ? new Date(userData.last_payment_date.toDate()) : null; 

            const today = new Date();
            let isAccessGranted = false;
            let errorMessage = "";

            if (createdDate && !lastPaymentDate) {
                const freeTrialExpirationDate = new Date(createdDate);
                freeTrialExpirationDate.setDate(freeTrialExpirationDate.getDate() + FREE_TRIAL_DURATION_DAYS);
                
                if (today <= freeTrialExpirationDate) {
                    isAccessGranted = true;
                } else {
                    errorMessage = `የነጻ የሙከራ ጊዜዎ አልቋል። አገልግሎቱን ለመቀጠል እባክዎ ክፍያ ይፈጽሙ። የደንበኝነት ምዝገባዎ በ ${freeTrialExpirationDate.toLocaleDateString('am-ET', { year: 'numeric', month: 'long', day: 'numeric' })} አብቅቷል።`;
                }
            } else if (lastPaymentDate) {
                const paidSubscriptionExpirationDate = new Date(lastPaymentDate);
                paidSubscriptionExpirationDate.setDate(paidSubscriptionExpirationDate.getDate() + PAID_SUBSCRIPTION_DURATION_DAYS);

                if (today <= paidSubscriptionExpirationDate) {
                    isAccessGranted = true;
                } else {
                    errorMessage = `የደንበኝነት ምዝገባ ጊዜዎ አልቋል። እባክዎ ያድሱ። የደንበኝነት ምዝገባዎ በ ${paidSubscriptionExpirationDate.toLocaleDateString('am-ET', { year: 'numeric', month: 'long', day: 'numeric' })} አብቅቷል።`;
                }
            } else {
                errorMessage = "ምዝገባዎ ሊታወቅ አልቻለም። እባክዎ ክፍያ ይፈጽሙ ወይም አስተዳዳሪን ያግኙ።";
            }

            if (!isAccessGranted) {
                showErrorMessage(errorMessage);
                loginAttemptCount++; // Increment attempt count
                if (loginAttemptCount >= 1) { // Show after 1st failed attempt
                    forgotPasswordLinkContainer.style.display = 'block';
                }
                loginButton.disabled = false;
                return;
            }
            
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('loggedInUserName', userData.full_name || 'ያልታወቀ ተጠቃሚ');
            localStorage.setItem('loggedInUserPhone', phoneNumber); 
            localStorage.setItem('loggedInUserPassword', password.toUpperCase()); 
            
            if (userData.last_payment_date && typeof userData.last_payment_date.toDate === 'function') {
                localStorage.setItem('loggedInUserLastPaymentDate', userData.last_payment_date.toDate().toISOString());
            } else if (userData.last_payment_date) {
                localStorage.setItem('loggedInUserLastPaymentDate', userData.last_payment_date);
            } else {
                localStorage.removeItem('loggedInUserLastPaymentDate');
            }
            
            alert("በተሳካ ሁኔታ ገብተዋል!");
            window.location.href = "stations_fuel_data.html"; 

        } catch (error) {
            console.error("Error during login:", error);
            showErrorMessage("በመግባት ላይ ችግር ተፈጥሯል። እባክዎ እንደገና ይሞክሩ።");
            loginAttemptCount++; // Increment attempt count
            if (loginAttemptCount >= 1) { // Show after 1st failed attempt
                forgotPasswordLinkContainer.style.display = 'block';
            }
            loginButton.disabled = false;
        }
    });

    // Forgot password functionality
    forgotPasswordTrigger.addEventListener('click', (event) => {
        event.preventDefault(); // Prevent default link behavior
        alert("የይለፍ ቃልዎን ለማግኘት ወደ ቴሌግራም ቦት ይሂዱ እና 'ፓስወርድ(Elan)' ብለው ይጻፉ።");
    });

</script>
</body>
</html>
