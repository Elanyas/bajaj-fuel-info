<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>የድራይቨር ነዳጅ መረጃ - የአድሚን ምዝገባ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <div class="login-section"> 
            <div class="login-form-card">
                <h2 class="form-title">ደንበኛ ያስመዝግቡ!</h2>
                <p class="form-subtitle">ክፍያ የተቀበሉ ደንበኞችን መረጃ ያስገቡ።</p>
                
                <div class="input-group">
                    <label for="fullNameInput" class="sr-only">ሙሉ ስም:</label>
                    <input type="text" id="fullNameInput" placeholder="ሙሉ ስም" required>
                </div>
                <div class="input-group">
                    <label for="phoneNumberInput" class="sr-only">ስልክ ቁጥር:</label>
                    <input type="tel" id="phoneNumberInput" placeholder="ስልክ ቁጥር (ለምሳሌ: 0912345678)" required>
                </div>
                <div class="input-group">
                    <label for="passwordInput" class="sr-only">የይለፍ ቃል:</label>
                    <input type="text" id="passwordInput" placeholder="የይለፍ ቃል (ቢያንስ 6 ፊደላት)" required>
                </div>
                <div class="input-group">
                    <label for="lastPaymentDateInput" class="sr-only">የክፍያ ቀን:</label>
                    <input type="date" id="lastPaymentDateInput" required>
                </div>
                
                <button id="registerButton">ደንበኛ ይመዝግቡ</button>
                
                <p id="errorMessage" class="error-message"></p>

                <p id="successMessage" class="success-message"></p>
            </div>
        </div>

        <div class="info-container">
            <h2 class="info-title">ለሹፌሮች ጠቃሚ መረጃ!</h2>
            <p><strong>ይህ ክፍል እንደ ማስታወሻ እና ማብራሪያ ተጨምሯል::</strong></p>

            <p>በእኛ መድረክ የሚከተሉትን ማግኘት ይችላሉ: </p>

            <p><strong>• የነዳጅ ማደያ ወቅታዊ መረጃ: </strong>የነዳጅ መኖር/አለመኖር፣ የነዳጅ አይነት፣ የዋጋ ግምት እና የወረፋ ሁኔታ መረጃ በእጃችሁ ይገኛል። </p>

            <p><strong>• የማህበረሰብ ልውውጥ: </strong>ሌሎች ሹፌሮች እና ባለቤቶች የሚለጥፏቸውን ተሞክሮዎች፣ ጠቃሚ ምክሮች እና ጥያቄዎች ማየትና መሳተፍ ይችላሉ። </p>

            <p><strong>• መሰረታዊ የባጃጅ ጥገና ምክሮች:</strong> ባጃጃችሁን በጥሩ ሁኔታ ለመጠበቅ የሚረዱ ጠቃሚ የእንክብካቤ መመሪያዎች። </p>

            <p><strong>• የመንገድ ትራንስፖርት መረጃዎች:</strong> አዳዲስ ህጎች፣ ደንቦች እና አጠቃላይ የትራንስፖርት ዜናዎች ማግኘት ይችላሉ። </p>

            <p><strong>• ያገለገሉ የባጃጅ ሽያጭ መረጃዎች: </strong>ባጃጅ ለመግዛትም ሆነ ለመሸጥ የምትፈልጉ ከሆነ ጠቃሚ መረጃዎችን ታገኛላችሁ። </p>

            <div class="info-section">
                <h3 class="section-heading">የአገልግሎታችን ጥቅሞች:</h3>
                <ul>
                    <li><p><strong>ጊዜ ለመቆጠብ:</strong> ወደ ነዳጅ ማደያ ከመሄድዎ በፊት ሁኔታውን በማየት ወረፋ ያለበትን ወይም ነዳጅ የሌለበትን ቦታ ለማወቅ ይረዳዎታል።</p></li>
                    <li><p><strong>ገንዘብ ለመቆጠብ:</strong> አላስፈላጊ ጉዞዎችን ይቀንሳሉ፣ ይህም ነዳጅዎን እና ጉልበትዎን ይቆጥባል።</p></li>
                    <li><p><strong>ለመረጃ ልውውጥ:</strong> ማነኛውንም መረጃ እርስ በእርስ ለመለዋወጥ እና የሹፌሮች ማህበረሰብ አካል ለመሆን ያስችልዎታል።</p></li>
                    <li><p><strong>በፍጥነት ለመወሰን:</strong> የትኛው ማደያ የተሻለ እንደሆነ ፈጣንና ትክክለኛ ውሳኔ እንዲወስኑ ያስችልዎታል።</p></li>
                </ul>
            </div>
            
            <p class="important-note"><strong> ድረ-ገጹ ስራዎን ለማቃለል እና ወጪዎን ለመቀነስ እንደሚረዳዎ እርግጠኞች ነን!</strong></p>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase configuration (ከ login.html ላይ የተወሰደ)
    const firebaseConfig = {
        apiKey: "AIzaSyA-ywRuhanxoEJgR83jwp_-nOkPY4jLOH4",
        authDomain: "elanyas-info.firebaseapp.com",
        projectId: "elanyas-info",
        storageBucket: "elanyas-info.firebasestorage.app",
        messagingSenderId: "769306910360",
        appId: "1:769306910360:web:70988eed5b1da8ffa0faed",
        measurementId: "G-2XX2B3RSGP"
    };

    // Firebaseን ማስጀመር
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // የ HTML ኤለመንቶችን መያዝ
    const fullNameInput = document.getElementById('fullNameInput');
    const phoneNumberInput = document.getElementById('phoneNumberInput');
    const passwordInput = document.getElementById('passwordInput');
    const lastPaymentDateInput = document.getElementById('lastPaymentDateInput'); // አዲስ የክፍያ ቀን ማስገቢያ
    const registerButton = document.getElementById('registerButton');
    const errorMessageDisplay = document.getElementById('errorMessage');
    const successMessageDisplay = document.getElementById('successMessage');

    // የስህተት መልእክት ለማሳየት
    function showErrorMessage(message) {
        errorMessageDisplay.textContent = message;
        errorMessageDisplay.style.opacity = "1";
        successMessageDisplay.style.opacity = "0"; // የስኬት መልእክት ይደብቃል
    }

    // የስኬት መልእክት ለማሳየት
    function showSuccessMessage(message) {
        successMessageDisplay.textContent = message;
        successMessageDisplay.style.opacity = "1";
        errorMessageDisplay.style.opacity = "0"; // የስህተት መልእክት ይደብቃል
    }

    // መልእክቶችን ለመደበቅ
    function hideMessages() {
        errorMessageDisplay.style.opacity = "0";
        errorMessageDisplay.textContent = "";
        successMessageDisplay.style.opacity = "0";
        successMessageDisplay.textContent = "";
    }

    // የምዝገባ ቁልፉ ሲጫን
    registerButton.addEventListener('click', async () => {
        hideMessages();

        const fullName = fullNameInput.value.trim();
        const phoneNumber = phoneNumberInput.value.trim();
        const password = passwordInput.value.trim();
        const lastPaymentDateStr = lastPaymentDateInput.value; // YYYY-MM-DD format

        // የመረጃ ማስገቢያው ባዶ አለመሆኑን ማረጋገጥ
        if (!fullName || !phoneNumber || !password || !lastPaymentDateStr) {
            showErrorMessage("እባክዎ ሁሉንም መስኮች ይሙሉ!");
            return;
        }

        // የስልክ ቁጥር ትክክለኛነት ማረጋገጥ
        if ((!phoneNumber.startsWith('09') && !phoneNumber.startsWith('07')) || phoneNumber.length !== 10 || !/^\d+$/.test(phoneNumber)) {
            showErrorMessage("ትክክለኛ የኢትዮጵያ ስልክ ቁጥር ያስገቡ (ለምሳሌ: 0912345678)");
            return;
        }

        // የይለፍ ቃል ርዝመት ማረጋገጥ
        if (password.length < 4) {
            showErrorMessage("የይለፍ ቃልዎ ቢያንስ 4 ፊደላት መሆን አለበት።");
            return;
        }
        
        // የይለፍ ቃል ትክክለኛ ፎርማት ማረጋገጥ (ፊደሎችን፣ ቁጥሮችን፣ ሰረዞችን (-) እና ክፍተቶችን (space) ሊይዝ ይችላል)
        if (!/^[a-zA-Z0-9\-\s]+$/.test(password)) {
            showErrorMessage("የይለፍ ቃልዎ ፊደሎችን፣ ቁጥሮችን፣ ሰረዞችን (-) እና ክፍተቶችን (space) ብቻ ሊይዝ ይችላል።");
            return;
        }

        // የክፍያ ቀንን ወደ Date object መቀየር
        let lastPaymentDate;
        try {
            lastPaymentDate = new Date(lastPaymentDateStr + 'T00:00:00'); // በኢትዮጵያ ሰዓት ዞን 00:00:00 ላይ ለማድረግ
            if (isNaN(lastPaymentDate.getTime())) {
                throw new Error("Invalid date");
            }
        } catch (e) {
            showErrorMessage("እባክዎ ትክክለኛ የክፍያ ቀን ያስገቡ።");
            return;
        }

        registerButton.disabled = true; // ምዝገባ እስኪጠናቀቅ አዝራሩን disable ማድረግ
        showErrorMessage("እየተመዘገበ ነው... እባክዎ ይጠብቁ።");

        try {
            // የይለፍ ቃሉን ወደ ትልቅ ፊደል መቀየር (ከቦቱ ጋር እንዲመጣጠን)
            const passwordUpper = password.toUpperCase();
            
            // የዶክመንት ID ለመፍጠር (ከቦቱ ጋር እንዲመጣጠን)
            const userDocId = `${phoneNumber}-${passwordUpper}`;
            const userDocRef = doc(db, "users", userDocId);

            // ተጠቃሚው አስቀድሞ መኖሩን ማረጋገጥ
            const userSnapshot = await getDoc(userDocRef);
            if (userSnapshot.exists()) {
                // አስቀድሞ ካለ update ያደርጋል
                await setDoc(userDocRef, {
                    full_name: fullName,
                    password: passwordUpper,
                    phone_number: phoneNumber,
                    registered_status: true,
                    last_payment_date: lastPaymentDate,
                    last_updated: new Date()
                }, { merge: true }); // merge: true ማለት ያሉትን አያስጠፋም አዲስ ካለ ይጨምራል
                showSuccessMessage("የደንበኛው መረጃ በተሳካ ሁኔታ ተሻሽሏል!");
            } else {
                // አዲስ ከሆነ ያስመዘግበዋል
                await setDoc(userDocRef, {
                    full_name: fullName,
                    password: passwordUpper,
                    phone_number: phoneNumber,
                    registered_status: true,
                    last_payment_date: lastPaymentDate,
                    created_at: new Date()
                });
                showSuccessMessage("ደንበኛው በተሳካ ሁኔታ ተመዝግቧል!");
            }

            // የገቡትን መረጃዎች ማጽዳት
            fullNameInput.value = '';
            phoneNumberInput.value = '';
            passwordInput.value = '';
            lastPaymentDateInput.value = '';

        } catch (error) {
            console.error("በምዝገባ/ማሻሻያ ላይ ስህተት ተፈጠረ:", error);
            showErrorMessage("በምዝገባ/ማሻሻያ ላይ ችግር ተፈጥሯል። እባክዎ እንደገና ይሞክሩ።");
        } finally {
            registerButton.disabled = false; // ምዝገባ ሲጠናቀቅ አዝራሩን enable ማድረግ
        }
    });

    </script>
</body>
</html>